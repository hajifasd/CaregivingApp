# 护工资源管理系统 - SQLite 到 MySQL 数据库迁移操作指南

## 📋 文档说明

**文档名称**：数据库迁移操作指南  
**适用系统**：护工资源管理系统  
**迁移类型**：SQLite → MySQL  
**创建时间**：2024年  
**版本**：1.0  
**维护团队**：护工资源管理系统开发团队  

## 🎯 迁移目标

将现有的 SQLite 数据库完整迁移到 MySQL 数据库，确保：
- 数据完整性（100% 数据保留）
- 功能兼容性（所有功能正常工作）
- 性能提升（MySQL 更好的并发性能）
- 可扩展性（支持更大规模部署）

## 📋 目录

1. [前置要求](#前置要求)
2. [环境准备](#环境准备)
3. [迁移步骤](#迁移步骤)
4. [验证测试](#验证测试)
5. [故障排除](#故障排除)
6. [回滚方案](#回滚方案)
7. [常见问题](#常见问题)

---

## 🔧 前置要求

### 系统要求
- **操作系统**：Windows 10/11, Linux, macOS
- **Python 版本**：3.8+
- **MySQL 版本**：8.0+
- **内存要求**：至少 4GB RAM
- **磁盘空间**：至少 2GB 可用空间

### 软件依赖
```bash
# 必需的 Python 包
Flask==2.3.3
Flask-SQLAlchemy==3.0.5
PyMySQL==1.1.0
cryptography==41.0.7
PyJWT==2.8.0
bcrypt==4.0.1
```

### 权限要求
- MySQL root 用户访问权限
- 数据库创建权限
- 文件读写权限

---

## 🚀 环境准备

### 1. MySQL 安装与配置

#### Windows 环境
```bash
# 检查 MySQL 服务状态
sc query MySQL80

# 启动 MySQL 服务
net start MySQL80

# 连接到 MySQL
mysql -u root -p
```

#### Linux 环境
```bash
# Ubuntu/Debian
sudo systemctl status mysql
sudo systemctl start mysql

# CentOS/RHEL
sudo systemctl status mysqld
sudo systemctl start mysqld
```

### 2. 环境变量配置

创建 `.env` 文件：
```env
# MySQL 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USERNAME=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=caregiving_db

# 应用安全配置
APP_SECRET=caregiving-system-secret-key-2024
FLASK_SECRET_KEY=your_unique_secret_key_here

# 管理员配置
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

### 3. 依赖安装

```bash
# 激活虚拟环境
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/macOS

# 安装依赖
pip install -r requirements.txt
```

---

## 📦 迁移步骤

### 步骤 1：备份 SQLite 数据

```bash
# 运行迁移脚本
python migrate_to_mysql.py
```

**预期输出**：
```
🚀 SQLite 到 MySQL 数据库迁移
==================================================
=== 备份 SQLite 数据 ===
✅ user: 4 条记录
✅ caregiver: 3 条记录
✅ service_type: 4 条记录
...
✅ 备份完成: sqlite_backup_20240901_143022.json
```

### 步骤 2：测试 MySQL 连接

```bash
# 测试连接
python migrate_to_mysql.py
```

**预期输出**：
```
=== 测试 MySQL 连接 ===
✅ MySQL 连接成功！
```

### 步骤 3：创建 MySQL 表结构

```bash
# 创建表结构
python migrate_to_mysql.py
```

**预期输出**：
```
=== 创建 MySQL 表结构 ===
✅ MySQL 表创建成功！
✅ 已创建 8 个表:
   - user
   - caregiver
   - service_type
   - job_data
   - analysis_result
   - appointment
   - employment
   - message
```

### 步骤 4：导入数据

```bash
# 导入数据
python import_data_to_mysql.py
```

**预期输出**：
```
🚀 开始数据导入到 MySQL
========================================
📁 使用备份文件: sqlite_backup_20240901_143022.json
=== 加载备份数据 ===
✅ 成功加载备份数据
   - user: 4 条记录
   - caregiver: 3 条记录
   ...
=== 导入数据到 MySQL ===
📥 导入表 service_type...
✅ service_type: 成功导入 4 条记录
...
🎉 数据导入完成！总共导入 18 条记录
```

### 步骤 5：验证迁移结果

```bash
# 验证数据
python import_data_to_mysql.py
```

**预期输出**：
```
=== 验证导入数据 ===
📊 数据统计:
   - user: 4 条记录
   - caregiver: 3 条记录
   - service_type: 4 条记录
   - job_data: 0 条记录
   - analysis_result: 0 条记录
   - appointment: 3 条记录
   - employment: 1 条记录
   - message: 3 条记录
```

---

## ✅ 验证测试

### 1. 应用启动测试

```bash
# 启动应用
cd back
python app.py
```

**验证点**：
- 应用正常启动
- 无数据库连接错误
- 页面正常加载

### 2. 功能测试

#### 用户登录测试
- 访问：`http://localhost:8000`
- 使用现有用户账号登录
- 验证登录成功

#### 管理员功能测试
- 访问：`http://localhost:8000/admin-login.html`
- 管理员登录
- 验证用户管理功能

#### 数据查询测试
- 验证用户列表显示
- 验证护工列表显示
- 验证预约记录显示

### 3. 数据完整性测试

```bash
# 检查数据记录数
python -c "
from back.config.settings import DATABASE_URI
from back.extensions import db
from flask import Flask
from back.models.user import User
from back.models.caregiver import Caregiver

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = DATABASE_URI
db.init_app(app)

with app.app_context():
    UserModel = User.get_model(db)
    CaregiverModel = Caregiver.get_model(db)
    print(f'用户数: {UserModel.query.count()}')
    print(f'护工数: {CaregiverModel.query.count()}')
"
```

---

## 🔧 故障排除

### 常见错误及解决方案

#### 1. MySQL 连接失败
```
❌ MySQL 连接失败: (1045, "Access denied for user 'root'@'localhost'")
```

**解决方案**：
- 检查 MySQL 服务是否运行
- 验证 root 密码是否正确
- 确认用户权限

#### 2. 表已存在错误
```
❌ 创建表失败: (1050, "Table 'user' already exists")
```

**解决方案**：
- 删除现有表：`DROP TABLE user;`
- 或使用 `CREATE TABLE IF NOT EXISTS`

#### 3. 数据导入失败
```
❌ 导入失败: (1366, "Incorrect string value")
```

**解决方案**：
- 检查字符集设置
- 确保使用 `utf8mb4` 字符集

#### 4. 应用启动失败
```
❌ 应用启动失败: No module named 'back'
```

**解决方案**：
- 确保在正确的目录运行
- 检查 Python 路径设置

### 日志分析

#### 查看应用日志
```bash
# 启动应用时查看详细日志
python app.py --debug
```

#### 查看 MySQL 日志
```bash
# Windows
tail -f "C:\ProgramData\MySQL\MySQL Server 8.0\Data\hostname.err"

# Linux
sudo tail -f /var/log/mysql/error.log
```

---

## 🔄 回滚方案

### 1. 数据回滚

如果迁移失败，可以回滚到 SQLite：

```bash
# 1. 停止应用
# 2. 修改配置文件
# 在 back/config/settings.py 中注释 MySQL 配置，启用 SQLite 配置

# 3. 重新启动应用
python app.py
```

### 2. 配置回滚

```python
# back/config/settings.py
# 注释 MySQL 配置
# DATABASE_URI = f'mysql+pymysql://{MYSQL_USERNAME}:{MYSQL_PASSWORD}@{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DATABASE}?charset=utf8mb4'

# 启用 SQLite 配置
DATABASE_URI = 'sqlite:///{}'.format(os.path.join(ROOT_DIR, "database", "caregiving.db"))
```

### 3. 完整回滚脚本

```bash
# 创建回滚脚本
cat > rollback_to_sqlite.py << 'EOF'
#!/usr/bin/env python3
"""
回滚到 SQLite 数据库
"""
import os
import shutil

# 备份当前配置
shutil.copy('back/config/settings.py', 'back/config/settings.py.backup')

# 恢复 SQLite 配置
with open('back/config/settings.py', 'r') as f:
    content = f.read()

content = content.replace(
    "DATABASE_URI = f'mysql+pymysql://{MYSQL_USERNAME}:{MYSQL_PASSWORD}@{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DATABASE}?charset=utf8mb4'",
    "# DATABASE_URI = f'mysql+pymysql://{MYSQL_USERNAME}:{MYSQL_PASSWORD}@{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DATABASE}?charset=utf8mb4'"
)

content = content.replace(
    "# DATABASE_URI = 'sqlite:///{}'.format(os.path.join(ROOT_DIR, \"database\", \"caregiving.db\"))",
    "DATABASE_URI = 'sqlite:///{}'.format(os.path.join(ROOT_DIR, \"database\", \"caregiving.db\"))"
)

with open('back/config/settings.py', 'w') as f:
    f.write(content)

print("✅ 已回滚到 SQLite 配置")
EOF

# 运行回滚
python rollback_to_sqlite.py
```

---

## ❓ 常见问题

### Q1: 迁移过程中断怎么办？
**A**: 重新运行迁移脚本，脚本会自动跳过已完成的步骤。

### Q2: 数据量很大，迁移时间很长？
**A**: 这是正常现象，建议在低峰期进行迁移。

### Q3: 迁移后应用性能如何？
**A**: MySQL 通常比 SQLite 有更好的并发性能，特别是在多用户场景下。

### Q4: 如何备份 MySQL 数据？
**A**: 使用 `mysqldump` 命令：
```bash
mysqldump -u root -p caregiving_db > backup.sql
```

### Q5: 迁移后如何监控数据库性能？
**A**: 使用 MySQL 监控工具或应用日志监控。

---

## 📞 技术支持

### 联系方式
- **技术团队**：护工资源管理系统开发团队
- **邮箱**：support@caregiving-system.com
- **文档版本**：1.0
- **最后更新**：2024年

### 更新日志
- **v1.0** (2024-01-01)：初始版本，完整的迁移指南

---

## 📄 许可证

本文档仅供护工资源管理系统内部使用，未经授权不得外传。

---

*文档结束*
