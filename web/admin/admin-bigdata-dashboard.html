<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¤ç†åŠ©æ‰‹ -/* ç”¨æˆ·ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <!-- å¼•å…¥è®¤è¯å®ˆå« -->
    <script src="/js/admin-auth-guard.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 10px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">æŠ¤å·¥èµ„æºç®¡ç†ç³»ç»Ÿ - å¤§æ•°æ®åˆ†æ</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="triggerDynamicAnalysis()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        è§¦å‘åŠ¨æ€åˆ†æ
                    </button>
                    <div class="relative">
                        <button onclick="toggleExportMenu()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                            å¯¼å‡ºæŠ¥å‘Š â–¼
                        </button>
                        <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                            <div class="py-1">
                                <button onclick="exportReport('excel')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    ğŸ“Š å¯¼å‡ºExcelæŠ¥å‘Š
                                </button>
                                <button onclick="exportReport('pdf')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    ğŸ“„ å¯¼å‡ºPDFæŠ¥å‘Š
                                </button>
                                <button onclick="showExportHistory()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    ğŸ“ å¯¼å‡ºå†å²
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        åˆ·æ–°æ•°æ®
                    </button>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- æ§åˆ¶å°ï¼šç­›é€‰ä¸åˆ·æ–° -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col lg:flex-row lg:items-end lg:space-x-4 space-y-4 lg:space-y-0">
                <div class="flex-1">
                    <label class="block text-sm text-gray-600 mb-1">æ—¥æœŸèŒƒå›´</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input id="filterStart" type="date" class="border rounded px-3 py-2" />
                        <input id="filterEnd" type="date" class="border rounded px-3 py-2" />
                    </div>
                </div>
                <div class="flex-1">
                    <label class="block text-sm text-gray-600 mb-1">åŸå¸‚</label>
                    <select id="filterCity" class="border rounded px-3 py-2 w-full">
                        <option value="">å…¨éƒ¨</option>
                        <option>åŒ—äº¬</option>
                        <option>ä¸Šæµ·</option>
                        <option>å¹¿å·</option>
                        <option>æ·±åœ³</option>
                        <option>å…¶ä»–</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm text-gray-600 mb-1">æœåŠ¡ç±»å‹</label>
                    <select id="filterService" class="border rounded px-3 py-2 w-full">
                        <option value="">å…¨éƒ¨</option>
                        <option>å…»è€æŠ¤ç†</option>
                        <option>åº·å¤æŠ¤ç†</option>
                        <option>åŒ»ç–—æŠ¤ç†</option>
                        <option>ç»¼åˆæŠ¤ç†</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="autoRefresh" type="checkbox" class="h-4 w-4" />
                    <label for="autoRefresh" class="text-sm text-gray-700">è‡ªåŠ¨åˆ·æ–°</label>
                    <select id="refreshInterval" class="border rounded px-2 py-1">
                        <option value="30">30s</option>
                        <option value="60">60s</option>
                        <option value="120">120s</option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">åº”ç”¨ç­›é€‰</button>
                    <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">é‡ç½®</button>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾å¯¼èˆª -->
        <div class="mb-6">
            <div class="flex flex-wrap gap-2">
                <a href="#section-overview" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">æ¦‚è§ˆ</a>
                <a href="#section-distribution" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">åˆ†å¸ƒåˆ†æ</a>
                <a href="#section-trends" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">è¶‹åŠ¿åˆ†æ</a>
                <a href="#section-prediction" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">é¢„æµ‹åˆ†æ</a>
                <a href="#section-cluster" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">èšç±»åˆ†æ</a>
                <a href="#section-forecast" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">éœ€æ±‚é¢„æµ‹</a>
                <a href="#section-reco" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">æ¨è</a>
            </div>
        </div>
        <!-- åŠ¨æ€åˆ†æçŠ¶æ€ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">åŠ¨æ€åˆ†æçŠ¶æ€</h2>
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">åˆ†æçŠ¶æ€</h3>
                    <div class="flex space-x-2">
                        <button onclick="getLatestAnalysis()" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            è·å–æœ€æ–°åˆ†æ
                        </button>
                        <button onclick="showAnalysisHistory()" class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                            åˆ†æå†å²
                        </button>
                    </div>
                </div>
                <div id="analysis-status" class="text-sm text-gray-600">
                    ç­‰å¾…åˆ†æ...
                </div>
            </div>
            
            <!-- å¯¼å‡ºçŠ¶æ€ -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">å¯¼å‡ºçŠ¶æ€</h3>
                    <div class="flex space-x-2">
                        <button onclick="refreshExportList()" class="bg-green-500 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                </div>
                <div id="export-status" class="text-sm text-gray-600 mb-4">
                    ç­‰å¾…å¯¼å‡º...
                </div>
                <div id="export-list" class="space-y-2">
                    <!-- å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ç³»ç»ŸçŠ¶æ€</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="stat-value" id="spark-status">è¿è¡Œä¸­</div>
                    <div class="stat-label">SparkçŠ¶æ€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="hadoop-status">è¿è¡Œä¸­</div>
                    <div class="stat-label">HadoopçŠ¶æ€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mongodb-status">è¿è¡Œä¸­</div>
                    <div class="stat-label">MongoDBçŠ¶æ€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="processing-status">æ´»è·ƒ</div>
                    <div class="stat-label">æ•°æ®å¤„ç†çŠ¶æ€</div>
                </div>
            </div>
        </div>

        <!-- å…³é”®æŒ‡æ ‡ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å…³é”®æŒ‡æ ‡</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="stat-card">
                    <div class="stat-value" id="total-caregivers">-</div>
                    <div class="stat-label">æ€»æŠ¤å·¥æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-users">-</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-appointments">-</div>
                    <div class="stat-label">æ€»é¢„çº¦æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-rating">-</div>
                    <div class="stat-label">å¹³å‡è¯„åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="data-quality">-</div>
                    <div class="stat-label">æ•°æ®è´¨é‡</div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div id="section-overview" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!--/* ç”¨æˆ·åˆ†å¸ƒåˆ†æ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">æŠ¤å·¥åˆ†å¸ƒåˆ†æ</h3>
                <div class="flex justify-end mb-2">
                    <button class="text-sm text-blue-600 hover:underline mr-3" onclick="exportPlot('caregiver-distribution-chart','caregiver_distribution')">å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="text-sm text-blue-600 hover:underline" onclick="exportCSV(distributionLastData, 'caregiver_distribution')">å¯¼å‡ºCSV</button>
                </div>
                <div id="caregiver-distribution-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- å¸‚åœºè¶‹åŠ¿åˆ†æ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">å¸‚åœºè¶‹åŠ¿åˆ†æ</h3>
                <div class="flex justify-end mb-2">
                    <button class="text-sm text-blue-600 hover:underline mr-3" onclick="exportPlot('market-trends-chart','market_trends')">å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="text-sm text-blue-600 hover:underline" onclick="exportCSV(trendsLastData, 'market_trends')">å¯¼å‡ºCSV</button>
                </div>
                <div id="market-trends-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div id="section-prediction" class="lg:col-span-2"></div>
            <!-- æˆåŠŸç‡é¢„æµ‹ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">æˆåŠŸç‡é¢„æµ‹</h3>
                <div class="flex justify-end mb-2">
                    <button class="text-sm text-blue-600 hover:underline mr-3" onclick="exportPlot('success-prediction-chart','success_prediction')">å¯¼å‡ºå›¾ç‰‡</button>
                </div>
                <div id="success-prediction-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- èšç±»åˆ†æ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">æŠ¤å·¥èšç±»åˆ†æ</h3>
                <div class="flex justify-end mb-2">
                    <button class="text-sm text-blue-600 hover:underline mr-3" onclick="exportPlot('cluster-analysis-chart','cluster_analysis')">å¯¼å‡ºå›¾ç‰‡</button>
                </div>
                <div id="cluster-analysis-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div id="section-forecast" class="lg:col-span-2"></div>
            <!-- éœ€æ±‚é¢„æµ‹ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">éœ€æ±‚é¢„æµ‹</h3>
                <div class="flex justify-end mb-2">
                    <button class="text-sm text-blue-600 hover:underline mr-3" onclick="exportPlot('demand-forecast-chart','demand_forecast')">å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="text-sm text-blue-600 hover:underline" onclick="exportCSV(forecastLastData, 'demand_forecast')">å¯¼å‡ºCSV</button>
                </div>
                <div id="demand-forecast-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- æ¨èåˆ†æ -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold mb-4">æ¨èåˆ†æ</h3>
                <div class="flex justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-600">ç”¨æˆ·ID</label>
                        <input id="recoUserId" type="number" class="border rounded px-2 py-1 w-28" placeholder="1" />
                        <button class="text-sm bg-blue-600 text-white px-3 py-1 rounded" onclick="loadRecommendations()">è·å–æ¨è</button>
                    </div>
                    <div>
                        <button class="text-sm text-blue-600 hover:underline" onclick="exportCSV(recommendationLastData, 'recommendations')">å¯¼å‡ºCSV</button>
                    </div>
                </div>
                <div id="recommendation-chart" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¤„ç†æ§åˆ¶ -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">æ•°æ®å¤„ç†æ§åˆ¶</h2>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex space-x-4">
                    <button onclick="startDataProcessing()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        å¯åŠ¨æ•°æ®å¤„ç†
                    </button>
                    <button onclick="startCrawling()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        å¯åŠ¨æ•°æ®çˆ¬å–
                    </button>
                    <button onclick="generateReport()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        ç”Ÿæˆåˆ†ææŠ¥å‘Š
                    </button>
                </div>
                <div id="processing-status" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let dashboardData = {};
        let charts = {};
        let autoRefreshTimer = null;
        let distributionLastData = null;
        let trendsLastData = null;
        let forecastLastData = null;
        let recommendationLastData = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initFilters();
            loadDashboardData();
            loadAllCharts();
            initAutoRefresh();
        });

        function initFilters() {
            document.getElementById('applyFilters').addEventListener('click', () => {
                loadDashboardData();
                loadAllCharts();
            });
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('filterStart').value = '';
                document.getElementById('filterEnd').value = '';
                document.getElementById('filterCity').value = '';
                document.getElementById('filterService').value = '';
                loadDashboardData();
                loadAllCharts();
            });
        }

        function initAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            const intervalSel = document.getElementById('refreshInterval');
            function setup() {
                if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
                if (checkbox.checked) {
                    const sec = parseInt(intervalSel.value || '30', 10);
                    autoRefreshTimer = setInterval(() => {
                        loadDashboardData();
                        loadAllCharts();
                    }, sec * 1000);
                }
            }
            checkbox.addEventListener('change', setup);
            intervalSel.addEventListener('change', setup);
        }

        function getFiltersQuery() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const city = document.getElementById('filterCity').value;
            const service = document.getElementById('filterService').value;
            const params = new URLSearchParams();
            if (start) params.append('start', start);
            if (end) params.append('end', end);
            if (city) params.append('city', city);
            if (service) params.append('service_type', service);
            const qs = params.toString();
            return qs ? ('?' + qs) : '';
        }

        async function fetchJson(url, options = {}) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯ ' + res.status);
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
                return data.data || {};
            } catch (e) {
                console.error('è¯·æ±‚å¤±è´¥:', e);
                throw e;
            }
        }

        function setLoading(containerId) {
            const el = document.getElementById(containerId);
            if (!el) return;
            el.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        }

        function setError(containerId, msg) {
            const el = document.getElementById(containerId);
            if (!el) return;
            el.innerHTML = `<div class="text-center text-red-600 py-10">${msg || 'åŠ è½½å¤±è´¥'}</div>`;
        }

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/bigdata/dashboard');
                const result = await response.json();
                
                if (result.success) {
                    dashboardData = result.data;
                    updateSummaryCards();
                } else {
                    console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®é”™è¯¯:', error);
            }
        }

        // æ›´æ–°æ‘˜è¦å¡ç‰‡
        function updateSummaryCards() {
            const summary = dashboardData.summary || {};
            
            document.getElementById('total-caregivers').textContent = summary.total_caregivers || '-';
            document.getElementById('total-users').textContent = summary.total_users || '-';
            document.getElementById('total-appointments').textContent = summary.total_appointments || '-';
            document.getElementById('avg-rating').textContent = summary.avg_rating || '-';
            document.getElementById('data-quality').textContent = (summary.data_quality_score * 100).toFixed(1) + '%';
        }

        // åŠ è½½æ‰€æœ‰å›¾è¡¨
        async function loadAllCharts() {
            await Promise.all([
                loadCaregiverDistributionChart(),
                loadMarketTrendsChart(),
                loadSuccessPredictionChart(),
                loadClusterAnalysisChart(),
                loadDemandForecastChart()
            ]);
        }

        // åŠ è½½æŠ¤å·¥åˆ†å¸ƒå›¾è¡¨
        async function loadCaregiverDistributionChart() {
            const container = 'caregiver-distribution-chart';
            setLoading(container);
            try {
                const data = await fetchJson('/api/bigdata/analysis/caregiver-distribution' + getFiltersQuery());
                distributionLastData = data;
                createDistributionChart(data);
            } catch (error) {
                setError(container, 'æŠ¤å·¥åˆ†å¸ƒåŠ è½½å¤±è´¥');
            }
        }

        // åˆ›å»ºåˆ†å¸ƒå›¾è¡¨
        function createDistributionChart(data) {
            const traces = [
                {
                    x: Object.keys(data.age_distribution),
                    y: Object.values(data.age_distribution),
                    type: 'bar',
                    name: 'å¹´é¾„åˆ†å¸ƒ',
                    marker: { color: '#3498db' }
                },
                {
                    x: Object.keys(data.salary_distribution),
                    y: Object.values(data.salary_distribution),
                    type: 'bar',
                    name: 'è–ªèµ„åˆ†å¸ƒ',
                    marker: { color: '#e74c3c' }
                }
            ];

            const layout = {
                title: 'æŠ¤å·¥åˆ†å¸ƒç»Ÿè®¡',
                barmode: 'group',
                xaxis: { title: 'åˆ†ç±»' },
                yaxis: { title: 'æ•°é‡' }
            };

            Plotly.newPlot('caregiver-distribution-chart', traces, layout);
        }

        // åŠ è½½å¸‚åœºè¶‹åŠ¿å›¾è¡¨
        async function loadMarketTrendsChart() {
            const container = 'market-trends-chart';
            setLoading(container);
            try {
                const data = await fetchJson('/api/bigdata/analysis/market-trends' + getFiltersQuery());
                trendsLastData = data;
                createTrendsChart(data);
            } catch (error) {
                setError(container, 'å¸‚åœºè¶‹åŠ¿åŠ è½½å¤±è´¥');
            }
        }

        // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
        function createTrendsChart(data) {
            const traces = [
                {
                    x: data.map(d => d.date),
                    y: data.map(d => d.avg_salary),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'å¹³å‡è–ªèµ„',
                    line: { color: '#2ecc71' }
                },
                {
                    x: data.map(d => d.date),
                    y: data.map(d => d.job_count),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'èŒä½æ•°é‡',
                    yaxis: 'y2',
                    line: { color: '#f39c12' }
                }
            ];

            const layout = {
                title: 'å¸‚åœºè¶‹åŠ¿åˆ†æ',
                xaxis: { title: 'æ—¶é—´' },
                yaxis: { title: 'å¹³å‡è–ªèµ„', side: 'left' },
                yaxis2: { title: 'èŒä½æ•°é‡', side: 'right', overlaying: 'y' }
            };

            Plotly.newPlot('market-trends-chart', traces, layout);
        }

        // åŠ è½½æˆåŠŸç‡é¢„æµ‹å›¾è¡¨
        async function loadSuccessPredictionChart() {
            const container = 'success-prediction-chart';
            setLoading(container);
            try {
                const data = await fetchJson('/api/bigdata/analysis/success-prediction' + getFiltersQuery());
                createPredictionChart(data);
            } catch (error) {
                setError(container, 'æˆåŠŸç‡é¢„æµ‹åŠ è½½å¤±è´¥');
            }
        }

        // åˆ›å»ºé¢„æµ‹å›¾è¡¨
        function createPredictionChart(data) {
            const predictions = data.predictions;
            
            const trace = {
                x: predictions.map(p => p.actual_success_rate),
                y: predictions.map(p => p.predicted_success_rate),
                mode: 'markers',
                type: 'scatter',
                name: 'é¢„æµ‹ç»“æœ',
                text: predictions.map(p => p.name),
                marker: {
                    size: 10,
                    color: predictions.map(p => p.predicted_success_rate),
                    colorscale: 'Viridis'
                }
            };

            const layout = {
                title: `æˆåŠŸç‡é¢„æµ‹ (å‡†ç¡®ç‡: ${(data.model_accuracy * 100).toFixed(1)}%)`,
                xaxis: { title: 'å®é™…æˆåŠŸç‡' },
                yaxis: { title: 'é¢„æµ‹æˆåŠŸç‡' }
            };

            Plotly.newPlot('success-prediction-chart', [trace], layout);
        }

        // åŠ è½½èšç±»åˆ†æå›¾è¡¨
        async function loadClusterAnalysisChart() {
            const container = 'cluster-analysis-chart';
            setLoading(container);
            try {
                const data = await fetchJson('/api/bigdata/analysis/cluster-analysis' + getFiltersQuery());
                createClusterChart(data);
            } catch (error) {
                setError(container, 'èšç±»åˆ†æåŠ è½½å¤±è´¥');
            }
        }

        // åˆ›å»ºèšç±»å›¾è¡¨
        function createClusterChart(data) {
            const clusters = data.clusters;
            
            const trace = {
                x: clusters.map(c => c.avg_salary),
                y: clusters.map(c => c.avg_rating),
                mode: 'markers+text',
                type: 'scatter',
                text: clusters.map(c => c.name),
                textposition: 'top center',
                marker: {
                    size: clusters.map(c => c.count / 10),
                    color: clusters.map(c => c.cluster_id),
                    colorscale: 'Set1'
                }
            };

            const layout = {
                title: `æŠ¤å·¥èšç±»åˆ†æ (è½®å»“ç³»æ•°: ${data.silhouette_score.toFixed(2)})`,
                xaxis: { title: 'å¹³å‡è–ªèµ„' },
                yaxis: { title: 'å¹³å‡è¯„åˆ†' }
            };

            Plotly.newPlot('cluster-analysis-chart', [trace], layout);
        }

        // åŠ è½½éœ€æ±‚é¢„æµ‹å›¾è¡¨
        async function loadDemandForecastChart() {
            const container = 'demand-forecast-chart';
            setLoading(container);
            try {
                const data = await fetchJson('/api/bigdata/analysis/demand-forecast' + getFiltersQuery());
                forecastLastData = data;
                createForecastChart(data);
            } catch (error) {
                setError(container, 'éœ€æ±‚é¢„æµ‹åŠ è½½å¤±è´¥');
            }
        }

        async function loadRecommendations() {
            const container = 'recommendation-chart';
            setLoading(container);
            try {
                const uid = document.getElementById('recoUserId').value || '1';
                const data = await fetchJson(`/api/bigdata/analysis/recommendations?user_id=${encodeURIComponent(uid)}`);
                recommendationLastData = data.recommendations || [];
                createRecommendationTable(recommendationLastData);
            } catch (e) {
                setError(container, 'æ¨èç»“æœåŠ è½½å¤±è´¥');
            }
        }

        function createRecommendationTable(list) {
            const container = document.getElementById('recommendation-chart');
            if (!list || !list.length) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">æš‚æ— æ¨èæ•°æ®</div>';
                return;
            }
            const rows = list.map((r, idx) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${idx + 1}</td>
                    <td class="px-3 py-2">${r.caregiver_id}</td>
                    <td class="px-3 py-2">${r.name || ''}</td>
                    <td class="px-3 py-2">${(r.score * 100).toFixed(1)}%</td>
                    <td class="px-3 py-2">${r.hourly_rate ?? '-'}</td>
                    <td class="px-3 py-2">${r.rating ?? '-'}</td>
                    <td class="px-3 py-2 text-gray-500">${r.reason || ''}</td>
                </tr>
            `).join('');
            container.innerHTML = `
                <div class="overflow-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="text-left bg-gray-50">
                                <th class="px-3 py-2">#</th>
                                <th class="px-3 py-2">æŠ¤å·¥ID</th>
                                <th class="px-3 py-2">å§“å</th>
                                <th class="px-3 py-2">æ¨èåˆ†</th>
                                <th class="px-3 py-2">æ—¶è–ª</th>
                                <th class="px-3 py-2">è¯„åˆ†</th>
                                <th class="px-3 py-2">æ¨èç†ç”±</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // å¯¼å‡ºå·¥å…·
        function exportPlot(divId, filename) {
            const el = document.getElementById(divId);
            if (!el) return;
            Plotly.downloadImage(el, {format: 'png', filename: filename || 'chart', height: 600, width: 1000});
        }

        function exportCSV(data, filename) {
            try {
                let rows = [];
                if (Array.isArray(data)) {
                    rows = data;
                } else if (data && typeof data === 'object') {
                    rows = [data];
                }
                if (!rows.length) { showMessage('æ— å¯å¯¼å‡ºæ•°æ®', 'info'); return; }
                const headers = Object.keys(rows[0]);
                const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))).join('\n');
                const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (filename || 'export') + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥', e);
                showMessage('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // åˆ›å»ºé¢„æµ‹å›¾è¡¨
        function createForecastChart(data) {
            const forecast = data.forecast;
            
            const traces = [
                {
                    x: forecast.map(f => f.date),
                    y: forecast.map(f => f.predicted_demand),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'é¢„æµ‹éœ€æ±‚',
                    line: { color: '#e74c3c' }
                },
                {
                    x: forecast.map(f => f.date),
                    y: forecast.map(f => f.confidence_interval.upper),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ç½®ä¿¡åŒºé—´ä¸Šé™',
                    line: { color: 'rgba(231, 76, 60, 0.3)', dash: 'dash' }
                },
                {
                    x: forecast.map(f => f.date),
                    y: forecast.map(f => f.confidence_interval.lower),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ç½®ä¿¡åŒºé—´ä¸‹é™',
                    line: { color: 'rgba(231, 76, 60, 0.3)', dash: 'dash' },
                    fill: 'tonexty'
                }
            ];

            const layout = {
                title: `éœ€æ±‚é¢„æµ‹ (æ¨¡å‹å‡†ç¡®ç‡: ${(data.model_accuracy * 100).toFixed(1)}%)`,
                xaxis: { title: 'æ—¶é—´' },
                yaxis: { title: 'éœ€æ±‚æ•°é‡' }
            };

            Plotly.newPlot('demand-forecast-chart', traces, layout);
        }

        // å¯åŠ¨æ•°æ®å¤„ç†
        async function startDataProcessing() {
            try {
                const response = await fetch('/api/bigdata/process/start', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('æ•°æ®å¤„ç†å·²å¯åŠ¨', 'success');
                    monitorProcess(result.data.process_id);
                } else {
                    showMessage('å¯åŠ¨æ•°æ®å¤„ç†å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('å¯åŠ¨æ•°æ®å¤„ç†é”™è¯¯:', error);
                showMessage('å¯åŠ¨æ•°æ®å¤„ç†å¤±è´¥', 'error');
            }
        }

        // ç›‘æ§å¤„ç†è¿›åº¦
        async function monitorProcess(processId) {
            const statusDiv = document.getElementById('processing-status');
            statusDiv.innerHTML = '<div class="text-blue-600">æ­£åœ¨å¤„ç†æ•°æ®...</div>';
            
            // æ¨¡æ‹Ÿç›‘æ§è¿‡ç¨‹
            setTimeout(() => {
                statusDiv.innerHTML = '<div class="text-green-600">æ•°æ®å¤„ç†å®Œæˆ</div>';
            }, 3000);
        }

        // å¯åŠ¨æ•°æ®çˆ¬å–
        function startCrawling() {
            showMessage('æ•°æ®çˆ¬å–åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // ç”Ÿæˆåˆ†ææŠ¥å‘Š
        function generateReport() {
            showMessage('åˆ†ææŠ¥å‘Šç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadDashboardData();
            loadAllCharts();
            showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded shadow-lg z-50`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        // åŠ¨æ€åˆ†æåŠŸèƒ½
        async function triggerDynamicAnalysis() {
            try {
                const statusDiv = document.getElementById('analysis-status');
                statusDiv.innerHTML = '<div class="text-blue-600">æ­£åœ¨è§¦å‘åŠ¨æ€åˆ†æ...</div>';
                
                const response = await fetch('/api/bigdata/dynamic/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source: 'manual_trigger'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="text-green-600">
                            âœ… åŠ¨æ€åˆ†æè§¦å‘æˆåŠŸ<br>
                            åˆ†ææ—¶é—´: ${result.data.analysis_timestamp}<br>
                            æ•°æ®ç‰ˆæœ¬: ${result.data.data_version}<br>
                            æ•°æ®æº: ${result.data.data_sources.join(', ')}
                        </div>
                    `;
                    
                    // åˆ·æ–°æ•°æ®
                    setTimeout(() => {
                        loadDashboardData();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<div class="text-red-600">âŒ åŠ¨æ€åˆ†æè§¦å‘å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('è§¦å‘åŠ¨æ€åˆ†æå¤±è´¥:', error);
                document.getElementById('analysis-status').innerHTML = 
                    `<div class="text-red-600">âŒ è§¦å‘å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function getLatestAnalysis() {
            try {
                const statusDiv = document.getElementById('analysis-status');
                statusDiv.innerHTML = '<div class="text-blue-600">æ­£åœ¨è·å–æœ€æ–°åˆ†æç»“æœ...</div>';
                
                const response = await fetch('/api/bigdata/dynamic/latest');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    statusDiv.innerHTML = `
                        <div class="text-green-600">
                            âœ… æœ€æ–°åˆ†æç»“æœ<br>
                            åˆ†ææ—¶é—´: ${data.analysis_timestamp}<br>
                            æ•°æ®ç‰ˆæœ¬: ${data.data_version}<br>
                            è§¦å‘æº: ${data.trigger_source}<br>
                            æ•°æ®é‡: ${JSON.stringify(data.data_counts)}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="text-yellow-600">âš ï¸ ${result.message}</div>`;
                }
            } catch (error) {
                console.error('è·å–æœ€æ–°åˆ†æå¤±è´¥:', error);
                document.getElementById('analysis-status').innerHTML = 
                    `<div class="text-red-600">âŒ è·å–å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function showAnalysisHistory() {
            // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºåˆ†æå†å²
            alert('åˆ†æå†å²åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
        
        // åˆ‡æ¢å¯¼å‡ºèœå•
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('hidden');
        }
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('export-menu');
            const button = event.target.closest('button');
            if (!button || !button.onclick || button.onclick.toString().indexOf('toggleExportMenu') === -1) {
                menu.classList.add('hidden');
            }
        });
        
        // å¯¼å‡ºæŠ¥å‘Š
        async function exportReport(format) {
            try {
                const statusDiv = document.getElementById('export-status');
                statusDiv.innerHTML = `<div class="text-blue-600">æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æŠ¥å‘Š...</div>`;
                
                const response = await fetch(`/api/bigdata/export/${format}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="text-green-600">âœ… ${format.toUpperCase()}æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ: ${result.filename}</div>`;
                    
                    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `/api/bigdata/export/download/${result.filename}`;
                    downloadLink.download = result.filename;
                    downloadLink.className = 'inline-block mt-2 bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm';
                    downloadLink.textContent = 'ğŸ“¥ ä¸‹è½½æ–‡ä»¶';
                    downloadLink.onclick = () => {
                        setTimeout(() => {
                            refreshExportList();
                        }, 1000);
                    };
                    
                    statusDiv.appendChild(downloadLink);
                    
                    // åˆ·æ–°å¯¼å‡ºåˆ—è¡¨
                    setTimeout(() => {
                        refreshExportList();
                    }, 1000);
                } else {
                    statusDiv.innerHTML = `<div class="text-red-600">âŒ ${format.toUpperCase()}æŠ¥å‘Šå¯¼å‡ºå¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error);
                document.getElementById('export-status').innerHTML = 
                    `<div class="text-red-600">âŒ å¯¼å‡ºå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ˜¾ç¤ºå¯¼å‡ºå†å²
        async function showExportHistory() {
            await refreshExportList();
        }
        
        // åˆ·æ–°å¯¼å‡ºåˆ—è¡¨
        async function refreshExportList() {
            try {
                const response = await fetch('/api/bigdata/export/list');
                const result = await response.json();
                
                const listDiv = document.getElementById('export-list');
                
                if (result.success && result.files.length > 0) {
                    listDiv.innerHTML = result.files.map(file => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${file.filename}</div>
                                <div class="text-sm text-gray-500">
                                    å¤§å°: ${(file.size / 1024).toFixed(1)} KB | 
                                    ä¿®æ”¹æ—¶é—´: ${new Date(file.modified_time).toLocaleString()}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <a href="/api/bigdata/export/download/${file.filename}" 
                                   class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    ğŸ“¥ ä¸‹è½½
                                </a>
                                <button onclick="deleteExportFile('${file.filename}')" 
                                        class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— å¯¼å‡ºæ–‡ä»¶</div>';
                }
            } catch (error) {
                console.error('è·å–å¯¼å‡ºåˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('export-list').innerHTML = 
                    '<div class="text-red-500 text-center py-4">è·å–åˆ—è¡¨å¤±è´¥</div>';
            }
        }
        
        // åˆ é™¤å¯¼å‡ºæ–‡ä»¶
        async function deleteExportFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bigdata/export/delete/${filename}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    refreshExportList();
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                window.location.href = '/admin-login.html';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // åŠ è½½ç³»ç»ŸçŠ¶æ€
            loadSystemStatus();
            
            // åŠ è½½å¤§æ•°æ®çŠ¶æ€
            loadBigDataStatus();
            
            // åˆ·æ–°å¯¼å‡ºåˆ—è¡¨
            refreshExportList();
            
            // è·å–æœ€æ–°åˆ†æç»“æœ
            getLatestAnalysis();
        });
    </script>
</body>
</html>
