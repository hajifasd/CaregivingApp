<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šä¿¡è°ƒè¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .debug-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .debug-success { border-left: 4px solid #28a745; }
        .debug-error { border-left: 4px solid #dc3545; }
        .debug-warning { border-left: 4px solid #ffc107; }
        .debug-info { border-left: 4px solid #17a2b8; }
    </style>
</head>
<body class="p-6 bg-gray-100">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">é€šä¿¡è°ƒè¯•é¡µé¢</h1>
        
        <!-- ç”¨æˆ·ç«¯è°ƒè¯• -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">ç”¨æˆ·ç«¯è°ƒè¯•</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ç”¨æˆ·Token:</label>
                    <input type="text" id="user-token" placeholder="ç²˜è´´ç”¨æˆ·token" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">æŠ¤å·¥ID:</label>
                    <input type="text" id="caregiver-id" placeholder="è¾“å…¥æŠ¤å·¥ID" class="w-full p-2 border rounded">
                </div>
            </div>
            
            <div class="space-y-2 mb-4">
                <button onclick="debugUser()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    è°ƒè¯•ç”¨æˆ·ç«¯
                </button>
                <button onclick="connectUserWebSocket()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    è¿æ¥ç”¨æˆ·WebSocket
                </button>
                <button onclick="sendTestMessage()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    å‘é€æµ‹è¯•æ¶ˆæ¯
                </button>
            </div>
            
            <div id="user-debug" class="debug-container debug-info">
                <h3 class="font-bold mb-2">ç”¨æˆ·ç«¯è°ƒè¯•ä¿¡æ¯:</h3>
                <div id="user-debug-content">ç­‰å¾…è°ƒè¯•...</div>
            </div>
        </div>
        
        <!-- æŠ¤å·¥ç«¯è°ƒè¯• -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-purple-600">æŠ¤å·¥ç«¯è°ƒè¯•</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">æŠ¤å·¥Token:</label>
                    <input type="text" id="caregiver-token" placeholder="ç²˜è´´æŠ¤å·¥token" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">æ¶ˆæ¯å†…å®¹:</label>
                    <input type="text" id="test-message" value="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯" class="w-full p-2 border rounded">
                </div>
            </div>
            
            <div class="space-y-2 mb-4">
                <button onclick="debugCaregiver()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    è°ƒè¯•æŠ¤å·¥ç«¯
                </button>
                <button onclick="connectCaregiverWebSocket()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    è¿æ¥æŠ¤å·¥WebSocket
                </button>
                <button onclick="sendCaregiverMessage()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æŠ¤å·¥å‘é€æ¶ˆæ¯
                </button>
            </div>
            
            <div id="caregiver-debug" class="debug-container debug-info">
                <h3 class="font-bold mb-2">æŠ¤å·¥ç«¯è°ƒè¯•ä¿¡æ¯:</h3>
                <div id="caregiver-debug-content">ç­‰å¾…è°ƒè¯•...</div>
            </div>
        </div>
        
        <!-- é€šä¿¡çŠ¶æ€ -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 text-orange-600">é€šä¿¡çŠ¶æ€</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <div id="user-status" class="text-lg font-bold text-red-500">æœªè¿æ¥</div>
                    <div class="text-sm text-gray-600">ç”¨æˆ·ç«¯çŠ¶æ€</div>
                </div>
                <div class="text-center">
                    <div id="caregiver-status" class="text-lg font-bold text-red-500">æœªè¿æ¥</div>
                    <div class="text-sm text-gray-600">æŠ¤å·¥ç«¯çŠ¶æ€</div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="testFullCommunication()" class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600">
                    æµ‹è¯•å®Œæ•´é€šä¿¡
                </button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æ—¥å¿— -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">æ¶ˆæ¯æ—¥å¿—</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium mb-2">ç”¨æˆ·ç«¯æ”¶åˆ°çš„æ¶ˆæ¯:</h3>
                    <div id="user-messages" class="debug-container" style="height: 200px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">æŠ¤å·¥ç«¯æ”¶åˆ°çš„æ¶ˆæ¯:</h3>
                    <div id="caregiver-messages" class="debug-container" style="height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userSocket = null;
        let caregiverSocket = null;
        let userLoggedIn = false;
        let caregiverLoggedIn = false;
        
        // ç”¨æˆ·ç«¯è°ƒè¯•
        function debugUser() {
            const token = document.getElementById('user-token').value.trim();
            if (!token) {
                addDebugInfo('user', 'è¯·è¾“å…¥ç”¨æˆ·token', 'error');
                return;
            }
            
            try {
                // è§£æJWT token
                const payload = token.split('.')[1];
                if (payload) {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/')))));
                    addDebugInfo('user', `Tokenè§£ææˆåŠŸ: ${JSON.stringify(decoded, null, 2)}`, 'success');
                    
                    const userId = decoded.user_id;
                    if (userId) {
                        addDebugInfo('user', `ç”¨æˆ·ID: ${userId}`, 'success');
                        localStorage.setItem('user_token', token);
                    } else {
                        addDebugInfo('user', 'Tokenä¸­æœªæ‰¾åˆ°user_id', 'error');
                    }
                } else {
                    addDebugInfo('user', 'Tokenæ ¼å¼æ— æ•ˆ', 'error');
                }
            } catch (e) {
                addDebugInfo('user', `Tokenè§£æå¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        // æŠ¤å·¥ç«¯è°ƒè¯•
        function debugCaregiver() {
            const token = document.getElementById('caregiver-token').value.trim();
            if (!token) {
                addDebugInfo('caregiver', 'è¯·è¾“å…¥æŠ¤å·¥token', 'error');
                return;
            }
            
            try {
                // è§£æJWT token
                const payload = token.split('.')[1];
                if (payload) {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/')))));
                    addDebugInfo('caregiver', `Tokenè§£ææˆåŠŸ: ${JSON.stringify(decoded, null, 2)}`, 'success');
                    
                    const caregiverId = decoded.user_id || decoded.caregiver_id;
                    if (caregiverId) {
                        addDebugInfo('caregiver', `æŠ¤å·¥ID: ${caregiverId}`, 'success');
                        localStorage.setItem('caregiver_token', token);
                    } else {
                        addDebugInfo('caregiver', 'Tokenä¸­æœªæ‰¾åˆ°user_idæˆ–caregiver_id', 'error');
                    }
                } else {
                    addDebugInfo('caregiver', 'Tokenæ ¼å¼æ— æ•ˆ', 'error');
                }
            } catch (e) {
                addDebugInfo('caregiver', `Tokenè§£æå¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        // è¿æ¥ç”¨æˆ·WebSocket
        function connectUserWebSocket() {
            const token = localStorage.getItem('user_token');
            if (!token) {
                addDebugInfo('user', 'è¯·å…ˆè®¾ç½®ç”¨æˆ·token', 'error');
                return;
            }
            
            try {
                userSocket = io('http://localhost:8000');
                
                userSocket.on('connect', () => {
                    addDebugInfo('user', 'âœ… ç”¨æˆ·ç«¯WebSocketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('user', 'å·²è¿æ¥');
                    
                    // è§£æç”¨æˆ·ID
                    const payload = token.split('.')[1];
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/'))));
                    const userId = decoded.user_id;
                    
                    if (userId) {
                        userSocket.emit('join', {
                            user_id: userId,
                            user_type: 'user'
                        });
                        addDebugInfo('user', `ğŸ”— ç”¨æˆ· ${userId} æ­£åœ¨åŠ å…¥æˆ¿é—´...`, 'info');
                        userLoggedIn = true;
                    }
                });
                
                userSocket.on('joined_room', (data) => {
                    addDebugInfo('user', `âœ… ç”¨æˆ·å·²åŠ å…¥æˆ¿é—´: ${data.room}`, 'success');
                });
                
                userSocket.on('message_sent', (data) => {
                    addDebugInfo('user', `âœ… ç”¨æˆ·æ¶ˆæ¯å‘é€ç¡®è®¤: ${JSON.stringify(data)}`, 'success');
                });
                
                userSocket.on('message_received', (data) => {
                    addDebugInfo('user', `ğŸ“¨ ç”¨æˆ·æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                    addMessage('user', data);
                });
                
                userSocket.on('error', (data) => {
                    addDebugInfo('user', `âŒ ç”¨æˆ·ç«¯é”™è¯¯: ${data.message}`, 'error');
                });
                
                userSocket.on('disconnect', () => {
                    addDebugInfo('user', 'âŒ ç”¨æˆ·ç«¯WebSocketè¿æ¥æ–­å¼€', 'error');
                    updateStatus('user', 'å·²æ–­å¼€');
                });
                
            } catch (error) {
                addDebugInfo('user', `âŒ ç”¨æˆ·ç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è¿æ¥æŠ¤å·¥WebSocket
        function connectCaregiverWebSocket() {
            const token = localStorage.getItem('caregiver_token');
            if (!token) {
                addDebugInfo('caregiver', 'è¯·å…ˆè®¾ç½®æŠ¤å·¥token', 'error');
                return;
            }
            
            try {
                caregiverSocket = io('http://localhost:8000');
                
                caregiverSocket.on('connect', () => {
                    addDebugInfo('caregiver', 'âœ… æŠ¤å·¥ç«¯WebSocketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('caregiver', 'å·²è¿æ¥');
                    
                    // è§£ææŠ¤å·¥ID
                    const payload = token.split('.')[1];
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/'))));
                    const caregiverId = decoded.user_id || decoded.caregiver_id;
                    
                    if (caregiverId) {
                        caregiverSocket.emit('join', {
                            user_id: caregiverId,
                            user_type: 'caregiver'
                        });
                        addDebugInfo('caregiver', `ğŸ”— æŠ¤å·¥ ${caregiverId} æ­£åœ¨åŠ å…¥æˆ¿é—´...`, 'info');
                        caregiverLoggedIn = true;
                    }
                });
                
                caregiverSocket.on('joined_room', (data) => {
                    addDebugInfo('caregiver', `âœ… æŠ¤å·¥å·²åŠ å…¥æˆ¿é—´: ${data.room}`, 'success');
                });
                
                caregiverSocket.on('message_sent', (data) => {
                    addDebugInfo('caregiver', `âœ… æŠ¤å·¥æ¶ˆæ¯å‘é€ç¡®è®¤: ${JSON.stringify(data)}`, 'success');
                });
                
                caregiverSocket.on('message_received', (data) => {
                    addDebugInfo('caregiver', `ğŸ“¨ æŠ¤å·¥æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                    addMessage('caregiver', data);
                });
                
                caregiverSocket.on('error', (data) => {
                    addDebugInfo('caregiver', `âŒ æŠ¤å·¥ç«¯é”™è¯¯: ${data.message}`, 'error');
                });
                
                caregiverSocket.on('disconnect', () => {
                    addDebugInfo('caregiver', 'âŒ æŠ¤å·¥ç«¯WebSocketè¿æ¥æ–­å¼€', 'error');
                    updateStatus('caregiver', 'å·²æ–­å¼€');
                });
                
            } catch (error) {
                addDebugInfo('caregiver', `âŒ æŠ¤å·¥ç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å‘é€æµ‹è¯•æ¶ˆæ¯
        function sendTestMessage() {
            if (!userLoggedIn || !userSocket) {
                addDebugInfo('user', 'è¯·å…ˆè¿æ¥ç”¨æˆ·WebSocket', 'error');
                return;
            }
            
            const caregiverId = document.getElementById('caregiver-id').value.trim();
            if (!caregiverId) {
                addDebugInfo('user', 'è¯·è¾“å…¥æŠ¤å·¥ID', 'error');
                return;
            }
            
            const token = localStorage.getItem('user_token');
            const payload = token.split('.')[1];
            const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/'))));
            const userId = decoded.user_id;
            
            const messageData = {
                sender_id: userId,
                sender_type: 'user',
                sender_name: 'å¼ é˜¿å§¨',
                recipient_id: caregiverId,
                recipient_type: 'caregiver',
                content: 'ä½ å¥½ï¼ŒèŒ¶é²¤ï¼è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
                type: 'text'
            };
            
            userSocket.emit('send_message', messageData);
            addDebugInfo('user', `ğŸ“¤ ç”¨æˆ·å‘é€æ¶ˆæ¯: ${JSON.stringify(messageData)}`, 'info');
        }
        
        // æŠ¤å·¥å‘é€æ¶ˆæ¯
        function sendCaregiverMessage() {
            if (!caregiverLoggedIn || !caregiverSocket) {
                addDebugInfo('caregiver', 'è¯·å…ˆè¿æ¥æŠ¤å·¥WebSocket', 'error');
                return;
            }
            
            const token = localStorage.getItem('caregiver_token');
            const payload = token.split('.')[1];
            const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/'))));
            const caregiverId = decoded.user_id || decoded.caregiver_id;
            
            const messageContent = document.getElementById('test-message').value;
            
            const messageData = {
                sender_id: caregiverId,
                sender_type: 'caregiver',
                sender_name: 'èŒ¶é²¤',
                recipient_id: 'user_001', // å‡è®¾ç”¨æˆ·ID
                recipient_type: 'user',
                content: messageContent,
                type: 'text'
            };
            
            caregiverSocket.emit('send_message', messageData);
            addDebugInfo('caregiver', `ğŸ“¤ æŠ¤å·¥å‘é€æ¶ˆæ¯: ${JSON.stringify(messageData)}`, 'info');
        }
        
        // æµ‹è¯•å®Œæ•´é€šä¿¡
        function testFullCommunication() {
            if (!userLoggedIn || !caregiverLoggedIn) {
                alert('è¯·å…ˆè¿æ¥ç”¨æˆ·å’ŒæŠ¤å·¥WebSocket');
                return;
            }
            
            addDebugInfo('user', 'ğŸ§ª å¼€å§‹æµ‹è¯•å®Œæ•´é€šä¿¡...', 'info');
            addDebugInfo('caregiver', 'ğŸ§ª å¼€å§‹æµ‹è¯•å®Œæ•´é€šä¿¡...', 'info');
            
            // å»¶è¿Ÿå‘é€æ¶ˆæ¯
            setTimeout(() => {
                sendTestMessage();
            }, 1000);
        }
        
        // å·¥å…·å‡½æ•°
        function addDebugInfo(type, message, level = 'info') {
            const container = document.getElementById(`${type}-debug-content`);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `mb-2 p-2 rounded ${level === 'error' ? 'bg-red-100' : level === 'success' ? 'bg-green-100' : level === 'warning' ? 'bg-yellow-100' : 'bg-blue-100'}`;
            entry.innerHTML = `<span class="font-mono text-xs text-gray-500">[${timestamp}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function addMessage(type, data) {
            const container = document.getElementById(`${type}-messages`);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'mb-2 p-2 bg-gray-100 rounded';
            entry.innerHTML = `<span class="font-mono text-xs text-gray-500">[${timestamp}]</span> ${data.content} (æ¥è‡ª: ${data.sender_id})`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStatus(type, status) {
            const element = document.getElementById(`${type}-status`);
            element.textContent = status;
            element.className = `text-lg font-bold ${status === 'å·²è¿æ¥' ? 'text-green-500' : 'text-red-500'}`;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('user', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è°ƒè¯•é€šä¿¡åŠŸèƒ½', 'info');
            addDebugInfo('caregiver', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è°ƒè¯•é€šä¿¡åŠŸèƒ½', 'info');
        });
    </script>
</body>
</html>
