<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢è°ƒè¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">æœç´¢åŠŸèƒ½è°ƒè¯•</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h3 class="font-semibold mb-4">1. è®¾ç½®æµ‹è¯•æ•°æ®</h3>
            <button onclick="setupTestData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                è®¾ç½®æµ‹è¯•æ•°æ®
            </button>
            <div id="setup-status" class="mt-2 text-sm"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h3 class="font-semibold mb-4">2. æµ‹è¯•æœç´¢API</h3>
            <div class="flex gap-2 mb-2">
                <input type="text" id="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯" 
                       class="flex-1 p-2 border border-gray-300 rounded" value="å¼ ">
                <button onclick="testSearch()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æµ‹è¯•æœç´¢
                </button>
            </div>
            <div id="search-status" class="mt-2 text-sm"></div>
            <div id="search-results" class="mt-2"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-semibold mb-4">æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="console-log" class="bg-gray-100 p-4 rounded text-xs font-mono max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // é‡å†™console.logæ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-600' : 'text-gray-800';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        function setupTestData() {
            console.log('ğŸ”§ è®¾ç½®æµ‹è¯•æ•°æ®...');
            
            const userInfo = {
                id: 21,
                name: 'æµ‹è¯•ç”¨æˆ·',
                email: 'test@example.com'
            };
            
            localStorage.setItem('user_info', JSON.stringify(userInfo));
            localStorage.setItem('user_token', 'test-token-for-search');
            
            console.log('âœ… æµ‹è¯•æ•°æ®è®¾ç½®å®Œæˆ');
            console.log('ç”¨æˆ·ä¿¡æ¯:', userInfo);
            console.log('Token:', 'test-token-for-search');
            
            document.getElementById('setup-status').innerHTML = 
                '<span class="text-green-600">âœ… æµ‹è¯•æ•°æ®è®¾ç½®å®Œæˆ</span>';
        }
        
        async function testSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            if (!keyword) {
                console.log('âš ï¸ è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            console.log(`ğŸ” å¼€å§‹æœç´¢: "${keyword}"`);
            
            const token = localStorage.getItem('user_token');
            console.log('TokençŠ¶æ€:', token ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
            
            if (!token) {
                console.log('âŒ æ²¡æœ‰æ‰¾åˆ°tokenï¼Œè¯·å…ˆè®¾ç½®æµ‹è¯•æ•°æ®');
                document.getElementById('search-status').innerHTML = 
                    '<span class="text-red-600">âŒ è¯·å…ˆè®¾ç½®æµ‹è¯•æ•°æ®</span>';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('search-status').innerHTML = 
                '<span class="text-blue-600">ğŸ”„ æ­£åœ¨æœç´¢...</span>';
            
            try {
                const url = `/api/user/caregivers/search?keyword=${encodeURIComponent(keyword)}`;
                console.log('è¯·æ±‚URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”å¤´:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('å“åº”æ•°æ®:', result);
                    
                    if (result.success) {
                        console.log(`âœ… æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${result.data.length} ä¸ªæŠ¤å·¥`);
                        
                        document.getElementById('search-status').innerHTML = 
                            `<span class="text-green-600">âœ… æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${result.data.length} ä¸ªæŠ¤å·¥</span>`;
                        
                        // æ˜¾ç¤ºç»“æœ
                        const resultsDiv = document.getElementById('search-results');
                        if (result.data.length > 0) {
                            resultsDiv.innerHTML = `
                                <div class="mt-2 space-y-2">
                                    ${result.data.map(caregiver => `
                                        <div class="flex items-center p-3 bg-gray-50 rounded border">
                                            <img src="${caregiver.avatar}" alt="${caregiver.name}" 
                                                 class="w-10 h-10 rounded-full mr-3 object-cover">
                                            <div class="flex-1">
                                                <div class="font-medium">${caregiver.name}</div>
                                                <div class="text-sm text-gray-500">${caregiver.phone}</div>
                                            </div>
                                            <div class="text-xs text-gray-400">
                                                ID: ${caregiver.id}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            resultsDiv.innerHTML = '<div class="text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„æŠ¤å·¥</div>';
                        }
                    } else {
                        console.log('âŒ æœç´¢å¤±è´¥:', result.message);
                        document.getElementById('search-status').innerHTML = 
                            `<span class="text-red-600">âŒ æœç´¢å¤±è´¥: ${result.message}</span>`;
                    }
                } else {
                    console.log('âŒ è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                    
                    let errorText = '';
                    try {
                        const errorResult = await response.json();
                        errorText = errorResult.message || 'æœªçŸ¥é”™è¯¯';
                        console.log('é”™è¯¯è¯¦æƒ…:', errorResult);
                    } catch (e) {
                        errorText = `HTTP ${response.status}`;
                    }
                    
                    document.getElementById('search-status').innerHTML = 
                        `<span class="text-red-600">âŒ è¯·æ±‚å¤±è´¥: ${errorText}</span>`;
                }
            } catch (error) {
                console.log('âŒ æœç´¢å¼‚å¸¸:', error.message);
                document.getElementById('search-status').innerHTML = 
                    `<span class="text-red-600">âŒ æœç´¢å¼‚å¸¸: ${error.message}</span>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®¾ç½®æµ‹è¯•æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“‹ é¡µé¢åŠ è½½å®Œæˆ');
            setupTestData();
        });
    </script>
</body>
</html>
