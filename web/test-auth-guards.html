<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证守卫测试页面</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">认证守卫修复测试</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 用户端测试 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">用户端测试</h2>
                <div class="space-y-2">
                    <div>认证守卫: <span class="font-mono text-sm">user-auth-guard.js</span></div>
                    <div>Token检查: <span id="user-token-status" class="text-sm">检查中...</span></div>
                    <div>认证状态: <span id="user-auth-status" class="text-sm">检查中...</span></div>
                </div>
                <div class="mt-4">
                    <button onclick="testUserAuth()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        测试用户认证
                    </button>
                </div>
            </div>
            
            <!-- 护工端测试 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-green-600">护工端测试</h2>
                <div class="space-y-2">
                    <div>认证守卫: <span class="font-mono text-sm">caregiver-auth-guard.js</span></div>
                    <div>Token检查: <span id="caregiver-token-status" class="text-sm">检查中...</span></div>
                    <div>认证状态: <span id="caregiver-auth-status" class="text-sm">检查中...</span></div>
                </div>
                <div class="mt-4">
                    <button onclick="testCaregiverAuth()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        测试护工认证
                    </button>
                </div>
            </div>
            
            <!-- 管理端测试 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 text-purple-600">管理端测试</h2>
                <div class="space-y-2">
                    <div>认证守卫: <span class="font-mono text-sm">admin-auth-guard.js</span></div>
                    <div>Token检查: <span id="admin-token-status" class="text-sm">检查中...</span></div>
                    <div>认证状态: <span id="admin-auth-status" class="text-sm">检查中...</span></div>
                </div>
                <div class="mt-4">
                    <button onclick="testAdminAuth()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        测试管理认证
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 测试结果 -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">测试结果</h2>
            <div id="test-results" class="space-y-2">
                <div class="text-gray-500">等待测试...</div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="mt-8 text-center space-x-4">
            <button onclick="clearAllTokens()" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                清除所有Token
            </button>
            <button onclick="setTestTokens()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                设置测试Token
            </button>
            <button onclick="runAllTests()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                运行所有测试
            </button>
        </div>
    </div>

    <script>
        // 测试结果容器
        const testResults = document.getElementById('test-results');
        
        // 添加测试结果
        function addTestResult(message, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            div.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            testResults.appendChild(div);
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        // 检查Token状态
        function checkTokenStatus() {
            const userToken = localStorage.getItem('user_token');
            const caregiverToken = localStorage.getItem('caregiver_token');
            const adminToken = localStorage.getItem('admin_token');
            
            document.getElementById('user-token-status').textContent = userToken ? '已设置' : '未设置';
            document.getElementById('caregiver-token-status').textContent = caregiverToken ? '已设置' : '未设置';
            document.getElementById('admin-token-status').textContent = adminToken ? '已设置' : '未设置';
            
            return { userToken, caregiverToken, adminToken };
        }
        
        // 测试用户认证
        function testUserAuth() {
            addTestResult('开始测试用户认证...', 'info');
            
            const { userToken } = checkTokenStatus();
            
            if (!userToken) {
                addTestResult('❌ 用户Token未设置', 'error');
                document.getElementById('user-auth-status').textContent = '未认证';
                return;
            }
            
            try {
                // 模拟认证检查
                const payload = JSON.parse(atob(userToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                
                if (payload.user_type === 'user') {
                    addTestResult('✅ 用户认证检查通过', 'success');
                    document.getElementById('user-auth-status').textContent = '已认证';
                } else {
                    addTestResult('❌ 用户类型不匹配', 'error');
                    document.getElementById('user-auth-status').textContent = '认证失败';
                }
            } catch (error) {
                addTestResult('❌ Token解析失败: ' + error.message, 'error');
                document.getElementById('user-auth-status').textContent = 'Token无效';
            }
        }
        
        // 测试护工认证
        function testCaregiverAuth() {
            addTestResult('开始测试护工认证...', 'info');
            
            const { caregiverToken } = checkTokenStatus();
            
            if (!caregiverToken) {
                addTestResult('❌ 护工Token未设置', 'error');
                document.getElementById('caregiver-auth-status').textContent = '未认证';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(caregiverToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                
                if (payload.user_type === 'caregiver') {
                    addTestResult('✅ 护工认证检查通过', 'success');
                    document.getElementById('caregiver-auth-status').textContent = '已认证';
                } else {
                    addTestResult('❌ 用户类型不匹配', 'error');
                    document.getElementById('caregiver-auth-status').textContent = '认证失败';
                }
            } catch (error) {
                addTestResult('❌ Token解析失败: ' + error.message, 'error');
                document.getElementById('caregiver-auth-status').textContent = 'Token无效';
            }
        }
        
        // 测试管理认证
        function testAdminAuth() {
            addTestResult('开始测试管理认证...', 'info');
            
            const { adminToken } = checkTokenStatus();
            
            if (!adminToken) {
                addTestResult('❌ 管理Token未设置', 'error');
                document.getElementById('admin-auth-status').textContent = '未认证';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(adminToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                
                if (payload.user_type === 'admin') {
                    addTestResult('✅ 管理认证检查通过', 'success');
                    document.getElementById('admin-auth-status').textContent = '已认证';
                } else {
                    addTestResult('❌ 用户类型不匹配', 'error');
                    document.getElementById('admin-auth-status').textContent = '认证失败';
                }
            } catch (error) {
                addTestResult('❌ Token解析失败: ' + error.message, 'error');
                document.getElementById('admin-auth-status').textContent = 'Token无效';
            }
        }
        
        // 清除所有Token
        function clearAllTokens() {
            localStorage.removeItem('user_token');
            localStorage.removeItem('caregiver_token');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('caregiver_info');
            localStorage.removeItem('admin_info');
            
            checkTokenStatus();
            addTestResult('🗑️ 已清除所有Token', 'warning');
        }
        
        // 设置测试Token
        function setTestTokens() {
            // 创建测试Token（仅用于测试，实际应用中应该从服务器获取）
            const testUserToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX3R5cGUiOiJ1c2VyIiwiaWF0IjoxNzAzNDQ4MDAwLCJleHAiOjE3MDM1MzQ0MDB9.test';
            const testCaregiverToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX3R5cGUiOiJjYXJlZ2l2ZXIiLCJpYXQiOjE3MDM0NDgwMDAsImV4cCI6MTcwMzUzNDQwMH0.test';
            const testAdminToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjowLCJ1c2VyX3R5cGUiOiJhZG1pbiIsImlhdCI6MTcwMzQ0ODAwMCwiZXhwIjoxNzAzNTM0NDAwfQ.test';
            
            localStorage.setItem('user_token', testUserToken);
            localStorage.setItem('caregiver_token', testCaregiverToken);
            localStorage.setItem('admin_token', testAdminToken);
            
            checkTokenStatus();
            addTestResult('🔧 已设置测试Token', 'info');
        }
        
        // 运行所有测试
        function runAllTests() {
            addTestResult('🚀 开始运行所有认证测试...', 'info');
            testUserAuth();
            setTimeout(() => testCaregiverAuth(), 500);
            setTimeout(() => testAdminAuth(), 1000);
        }
        
        // 页面加载时检查Token状态
        document.addEventListener('DOMContentLoaded', function() {
            checkTokenStatus();
            addTestResult('📋 认证守卫修复测试页面已加载', 'info');
        });
    </script>
</body>
</html>
