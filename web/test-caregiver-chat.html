<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¤å·¥èŠå¤©åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .bg-primary { background-color: #165DFF; }
        .text-primary { color: #165DFF; }
        .border-primary { border-color: #165DFF; }
        .bg-success { background-color: #10B981; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">æŠ¤å·¥èŠå¤©åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="max-w-6xl mx-auto space-y-6">
            <!-- æµ‹è¯•è¯´æ˜ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-3">æµ‹è¯•è¯´æ˜</h2>
                <p class="text-blue-700 mb-3">è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æŠ¤å·¥ç«¯çš„èŠå¤©åŠŸèƒ½ï¼š</p>
                <ol class="list-decimal list-inside text-blue-700 space-y-1">
                    <li>æ¨¡æ‹ŸæŠ¤å·¥ç™»å½•çŠ¶æ€</li>
                    <li>åŠ è½½æŠ¤å·¥çš„è˜ç”¨åˆåŒåˆ—è¡¨ï¼ˆèŠå¤©ç”¨æˆ·ï¼‰</li>
                    <li>æµ‹è¯•ä¸ç”¨æˆ·çš„èŠå¤©åŠŸèƒ½</li>
                    <li>éªŒè¯æ¶ˆæ¯å‘é€å’Œæ¥æ”¶</li>
                </ol>
            </div>

            <!-- æŠ¤å·¥ç™»å½•çŠ¶æ€ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">æŠ¤å·¥ç™»å½•çŠ¶æ€</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span>æŠ¤å·¥IDï¼š</span>
                        <input type="text" id="caregiver-id" placeholder="è¾“å…¥æŠ¤å·¥ID" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div class="flex items-center justify-between">
                        <span>æŠ¤å·¥å§“åï¼š</span>
                        <input type="text" id="caregiver-name" placeholder="è¾“å…¥æŠ¤å·¥å§“å" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div class="flex items-center justify-between">
                        <span>ç™»å½•çŠ¶æ€ï¼š</span>
                        <span id="login-status" class="font-medium text-red-600">æœªç™»å½•</span>
                    </div>
                </div>
                <div class="mt-4 space-x-3">
                    <button onclick="loginCaregiver()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        ç™»å½•æŠ¤å·¥
                    </button>
                    <button onclick="logoutCaregiver()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ç™»å‡ºæŠ¤å·¥
                    </button>
                </div>
            </div>

            <!-- èŠå¤©åŠŸèƒ½æµ‹è¯• -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- èŠå¤©åˆ—è¡¨ -->
                <div class="lg:col-span-1 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">èŠå¤©åˆ—è¡¨</h3>
                    <div class="space-y-3">
                        <button onclick="loadChatList()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                            åŠ è½½èŠå¤©åˆ—è¡¨
                        </button>
                        <div id="chat-list" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">ç‚¹å‡»æŒ‰é’®åŠ è½½èŠå¤©åˆ—è¡¨</p>
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©çª—å£ -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">èŠå¤©çª—å£</h3>
                    <div id="chat-window" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium" id="chat-title">èŠå¤©çª—å£</h4>
                            <button onclick="closeChatWindow()" class="text-gray-500 hover:text-gray-700">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="chat-messages" class="h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50">
                            <p class="text-gray-500 text-center py-8">å¼€å§‹æ–°çš„å¯¹è¯</p>
                        </div>
                        
                        <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
                        <div class="flex gap-3">
                            <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <button onclick="sendMessage()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                å‘é€
                            </button>
                        </div>
                    </div>
                    
                    <div id="no-chat-selected" class="text-center py-12">
                        <i class="fa fa-comments text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©å¼€å§‹äº¤æµ</p>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ç»“æœ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">æµ‹è¯•ç»“æœ</h3>
                <div id="test-results" class="space-y-2 text-sm">
                    <p class="text-gray-500">ç­‰å¾…æµ‹è¯•ç»“æœ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentChatUser = null;
        let socket = null;
        let caregiverId = null;
        let caregiverName = '';

        // æŠ¤å·¥ç™»å½•
        function loginCaregiver() {
            const id = document.getElementById('caregiver-id').value.trim();
            const name = document.getElementById('caregiver-name').value.trim();
            
            if (!id || !name) {
                alert('è¯·è¾“å…¥æŠ¤å·¥IDå’Œå§“å');
                return;
            }
            
            caregiverId = id;
            caregiverName = name;
            
            // æ¨¡æ‹Ÿç™»å½•æˆåŠŸ
            document.getElementById('login-status').textContent = 'å·²ç™»å½•';
            document.getElementById('login-status').className = 'font-medium text-green-600';
            
            // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            initChat();
            
            addTestResult('âœ… æŠ¤å·¥ç™»å½•æˆåŠŸ', 'success');
        }

        // æŠ¤å·¥ç™»å‡º
        function logoutCaregiver() {
            caregiverId = null;
            caregiverName = '';
            
            document.getElementById('login-status').textContent = 'æœªç™»å½•';
            document.getElementById('login-status').className = 'font-medium text-red-600';
            
            // æ–­å¼€WebSocketè¿æ¥
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            addTestResult('âŒ æŠ¤å·¥å·²ç™»å‡º', 'error');
        }

        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        function initChat() {
            if (!caregiverId) {
                addTestResult('âŒ æŠ¤å·¥æœªç™»å½•ï¼Œæ— æ³•åˆå§‹åŒ–èŠå¤©åŠŸèƒ½', 'error');
                return;
            }

            try {
                // è¿æ¥WebSocket
                socket = io('http://localhost:8000');
                
                socket.on('connect', () => {
                    addTestResult('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                });
                
                socket.on('disconnect', () => {
                    addTestResult('âŒ WebSocketè¿æ¥æ–­å¼€', 'error');
                });
                
                socket.on('message_received', (data) => {
                    addTestResult(`ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯: ${data.content}`, 'info');
                    handleIncomingMessage(data);
                });
                
                addTestResult('âœ… èŠå¤©åŠŸèƒ½åˆå§‹åŒ–æˆåŠŸ', 'success');
                
            } catch (error) {
                addTestResult(`âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½èŠå¤©åˆ—è¡¨
        async function loadChatList() {
            if (!caregiverId) {
                addTestResult('âŒ æŠ¤å·¥æœªç™»å½•ï¼Œæ— æ³•åŠ è½½èŠå¤©åˆ—è¡¨', 'error');
                return;
            }

            try {
                addTestResult('ğŸ”„ æ­£åœ¨åŠ è½½èŠå¤©åˆ—è¡¨...', 'info');
                
                const response = await fetch(`/api/employment/contracts/caregiver/${caregiverId}`);
                const data = await response.json();

                if (data.success) {
                    const contracts = data.data.contracts || [];
                    displayChatList(contracts);
                    addTestResult(`âœ… æˆåŠŸåŠ è½½ ${contracts.length} ä¸ªèŠå¤©ç”¨æˆ·`, 'success');
                } else {
                    addTestResult(`âŒ åŠ è½½èŠå¤©åˆ—è¡¨å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ åŠ è½½èŠå¤©åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºèŠå¤©åˆ—è¡¨
        function displayChatList(contracts) {
            const chatList = document.getElementById('chat-list');
            
            if (contracts.length === 0) {
                chatList.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— èŠå¤©è®°å½•</p>';
                return;
            }

            const chatItems = contracts.map(contract => {
                const user = contract.user || {};
                const userName = user.name || user.username || 'ç”¨æˆ·';
                const lastMessage = contract.last_message_content || 'æš‚æ— æ¶ˆæ¯';
                const lastMessageTime = contract.last_message_time ? new Date(contract.last_message_time).toLocaleString('zh-CN') : '';
                
                return `
                    <div class="chat-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" 
                         onclick="openChat('${user.id}', '${userName}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                <i class="fa fa-user text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">${userName}</h4>
                                <p class="text-sm text-gray-600 truncate">${lastMessage}</p>
                                <p class="text-xs text-gray-500">${lastMessageTime}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            chatList.innerHTML = chatItems;
        }

        // æ‰“å¼€èŠå¤©çª—å£
        function openChat(userId, userName) {
            currentChatUser = { id: userId, name: userName };
            
            // æ˜¾ç¤ºèŠå¤©çª—å£
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('no-chat-selected').classList.add('hidden');
            document.getElementById('chat-title').textContent = `ä¸ ${userName} èŠå¤©`;
            
            // åŠ è½½èŠå¤©å†å²
            loadChatHistory(userId);
            
            addTestResult(`âœ… å·²æ‰“å¼€ä¸ ${userName} çš„èŠå¤©çª—å£`, 'success');
        }

        // å…³é—­èŠå¤©çª—å£
        function closeChatWindow() {
            document.getElementById('chat-window').classList.add('hidden');
            document.getElementById('no-chat-selected').classList.remove('hidden');
            currentChatUser = null;
            
            // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('chat-messages').innerHTML = '<p class="text-gray-500 text-center py-8">å¼€å§‹æ–°çš„å¯¹è¯</p>';
            document.getElementById('chat-input').value = '';
            
            addTestResult('âœ… èŠå¤©çª—å£å·²å…³é—­', 'info');
        }

        // åŠ è½½èŠå¤©å†å²
        async function loadChatHistory(userId) {
            if (!caregiverId) return;

            try {
                const response = await fetch(`/api/chat/history/${userId}?user_id=${caregiverId}&user_type=caregiver&limit=100`);
                const data = await response.json();

                if (data.success) {
                    const messages = data.data.messages || [];
                    displayChatHistory(messages);
                    addTestResult(`âœ… æˆåŠŸåŠ è½½ ${messages.length} æ¡èŠå¤©è®°å½•`, 'success');
                } else {
                    addTestResult(`âŒ åŠ è½½èŠå¤©å†å²å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ åŠ è½½èŠå¤©å†å²å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºèŠå¤©å†å²
        function displayChatHistory(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p class="text-gray-500 text-center py-8">å¼€å§‹æ–°çš„å¯¹è¯</p>';
                return;
            }

            const messagesHtml = messages.map(message => {
                const isOwnMessage = message.sender_id == caregiverId;
                const messageClass = isOwnMessage ? 'ml-auto bg-primary text-white' : 'mr-auto bg-gray-200 text-gray-800';
                
                return `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3">
                        <div class="max-w-xs ${messageClass} rounded-lg p-3">
                            <p class="text-sm">${message.content}</p>
                            <p class="text-xs ${isOwnMessage ? 'text-white/70' : 'text-gray-500'} mt-1">
                                ${new Date(message.timestamp).toLocaleString('zh-CN')}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            messagesContainer.innerHTML = messagesHtml;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (!currentChatUser || !caregiverId) {
                addTestResult('âŒ æ— æ³•å‘é€æ¶ˆæ¯ï¼šèŠå¤©æœªå¼€å§‹æˆ–æŠ¤å·¥æœªç™»å½•', 'error');
                return;
            }

            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (!content) {
                addTestResult('âŒ è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                return;
            }

            // æ„é€ æ¶ˆæ¯
            const message = {
                sender_id: caregiverId,
                sender_type: 'caregiver',
                sender_name: caregiverName,
                recipient_id: currentChatUser.id,
                recipient_type: 'user',
                content: content,
                type: 'text'
            };

            try {
                addTestResult('ğŸ”„ æ­£åœ¨å‘é€æ¶ˆæ¯...', 'info');
                
                // å‘é€æ¶ˆæ¯åˆ°åç«¯
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(message)
                });

                const data = await response.json();

                if (data.success) {
                    // æ·»åŠ åˆ°æœ¬åœ°æ˜¾ç¤º
                    addMessageToDisplay({
                        ...message,
                        timestamp: new Date().toISOString()
                    });

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    input.value = '';

                    addTestResult('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else {
                    addTestResult(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°æ˜¾ç¤ºåŒºåŸŸ
        function addMessageToDisplay(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const isOwnMessage = message.sender_id == caregiverId;
            const messageClass = isOwnMessage ? 'ml-auto bg-primary text-white' : 'mr-auto bg-gray-200 text-gray-800';
            
            const messageHtml = `
                <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3">
                    <div class="max-w-xs ${messageClass} rounded-lg p-3">
                        <p class="text-sm">${message.content}</p>
                        <p class="text-xs ${isOwnMessage ? 'text-white/70' : 'text-gray-500'} mt-1">
                            ${new Date(message.timestamp).toLocaleString('zh-CN')}
                        </p>
                    </div>
                </div>
            `;

            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleIncomingMessage(data) {
            // å¦‚æœå½“å‰èŠå¤©çª—å£æ‰“å¼€ä¸”æ¶ˆæ¯æ¥è‡ªå½“å‰èŠå¤©çš„ç”¨æˆ·
            if (currentChatUser && data.sender_id == currentChatUser.id) {
                addMessageToDisplay(data);
            }
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, type = 'info') {
            const resultsContainer = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const resultHtml = `
                <p class="${colorClass}">
                    [${timestamp}] ${message}
                </p>
            `;
            
            resultsContainer.insertAdjacentHTML('beforeend', resultHtml);
            
            // é™åˆ¶æ˜¾ç¤ºç»“æœæ•°é‡
            const results = resultsContainer.querySelectorAll('p');
            if (results.length > 20) {
                results[0].remove();
            }
        }

        // ç»‘å®šå›è½¦é”®å‘é€æ¶ˆæ¯
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'chat-input') {
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('ğŸš€ æŠ¤å·¥èŠå¤©åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
        });
    </script>
</body>
</html>
