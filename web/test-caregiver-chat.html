<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>护工聊天功能测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .bg-primary { background-color: #165DFF; }
        .text-primary { color: #165DFF; }
        .border-primary { border-color: #165DFF; }
        .bg-success { background-color: #10B981; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">护工聊天功能测试</h1>
        
        <div class="max-w-6xl mx-auto space-y-6">
            <!-- 测试说明 -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-3">测试说明</h2>
                <p class="text-blue-700 mb-3">这个页面用于测试护工端的聊天功能：</p>
                <ol class="list-decimal list-inside text-blue-700 space-y-1">
                    <li>模拟护工登录状态</li>
                    <li>加载护工的聘用合同列表（聊天用户）</li>
                    <li>测试与用户的聊天功能</li>
                    <li>验证消息发送和接收</li>
                </ol>
            </div>

            <!-- 护工登录状态 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">护工登录状态</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span>护工ID：</span>
                        <input type="text" id="caregiver-id" placeholder="输入护工ID" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div class="flex items-center justify-between">
                        <span>护工姓名：</span>
                        <input type="text" id="caregiver-name" placeholder="输入护工姓名" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div class="flex items-center justify-between">
                        <span>登录状态：</span>
                        <span id="login-status" class="font-medium text-red-600">未登录</span>
                    </div>
                </div>
                <div class="mt-4 space-x-3">
                    <button onclick="loginCaregiver()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        登录护工
                    </button>
                    <button onclick="logoutCaregiver()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        登出护工
                    </button>
                </div>
            </div>

            <!-- 聊天功能测试 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 聊天列表 -->
                <div class="lg:col-span-1 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">聊天列表</h3>
                    <div class="space-y-3">
                        <button onclick="loadChatList()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                            加载聊天列表
                        </button>
                        <div id="chat-list" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">点击按钮加载聊天列表</p>
                        </div>
                    </div>
                </div>

                <!-- 聊天窗口 -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">聊天窗口</h3>
                    <div id="chat-window" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium" id="chat-title">聊天窗口</h4>
                            <button onclick="closeChatWindow()" class="text-gray-500 hover:text-gray-700">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- 消息显示区域 -->
                        <div id="chat-messages" class="h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50">
                            <p class="text-gray-500 text-center py-8">开始新的对话</p>
                        </div>
                        
                        <!-- 消息输入区域 -->
                        <div class="flex gap-3">
                            <input type="text" id="chat-input" placeholder="输入消息..." 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <button onclick="sendMessage()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                发送
                            </button>
                        </div>
                    </div>
                    
                    <div id="no-chat-selected" class="text-center py-12">
                        <i class="fa fa-comments text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">请选择一个聊天开始交流</p>
                    </div>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">测试结果</h3>
                <div id="test-results" class="space-y-2 text-sm">
                    <p class="text-gray-500">等待测试结果...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentChatUser = null;
        let socket = null;
        let caregiverId = null;
        let caregiverName = '';

        // 护工登录
        function loginCaregiver() {
            const id = document.getElementById('caregiver-id').value.trim();
            const name = document.getElementById('caregiver-name').value.trim();
            
            if (!id || !name) {
                alert('请输入护工ID和姓名');
                return;
            }
            
            caregiverId = id;
            caregiverName = name;
            
            // 模拟登录成功
            document.getElementById('login-status').textContent = '已登录';
            document.getElementById('login-status').className = 'font-medium text-green-600';
            
            // 初始化聊天功能
            initChat();
            
            addTestResult('✅ 护工登录成功', 'success');
        }

        // 护工登出
        function logoutCaregiver() {
            caregiverId = null;
            caregiverName = '';
            
            document.getElementById('login-status').textContent = '未登录';
            document.getElementById('login-status').className = 'font-medium text-red-600';
            
            // 断开WebSocket连接
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            addTestResult('❌ 护工已登出', 'error');
        }

        // 初始化聊天功能
        function initChat() {
            if (!caregiverId) {
                addTestResult('❌ 护工未登录，无法初始化聊天功能', 'error');
                return;
            }

            try {
                // 连接WebSocket
                socket = io('http://localhost:8000');
                
                socket.on('connect', () => {
                    addTestResult('✅ WebSocket连接成功', 'success');
                });
                
                socket.on('disconnect', () => {
                    addTestResult('❌ WebSocket连接断开', 'error');
                });
                
                socket.on('message_received', (data) => {
                    addTestResult(`📨 收到新消息: ${data.content}`, 'info');
                    handleIncomingMessage(data);
                });
                
                addTestResult('✅ 聊天功能初始化成功', 'success');
                
            } catch (error) {
                addTestResult(`❌ WebSocket连接失败: ${error.message}`, 'error');
            }
        }

        // 加载聊天列表
        async function loadChatList() {
            if (!caregiverId) {
                addTestResult('❌ 护工未登录，无法加载聊天列表', 'error');
                return;
            }

            try {
                addTestResult('🔄 正在加载聊天列表...', 'info');
                
                const response = await fetch(`/api/employment/contracts/caregiver/${caregiverId}`);
                const data = await response.json();

                if (data.success) {
                    const contracts = data.data.contracts || [];
                    displayChatList(contracts);
                    addTestResult(`✅ 成功加载 ${contracts.length} 个聊天用户`, 'success');
                } else {
                    addTestResult(`❌ 加载聊天列表失败: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`❌ 加载聊天列表失败: ${error.message}`, 'error');
            }
        }

        // 显示聊天列表
        function displayChatList(contracts) {
            const chatList = document.getElementById('chat-list');
            
            if (contracts.length === 0) {
                chatList.innerHTML = '<p class="text-gray-500 text-center py-8">暂无聊天记录</p>';
                return;
            }

            const chatItems = contracts.map(contract => {
                const user = contract.user || {};
                const userName = user.name || user.username || '用户';
                const lastMessage = contract.last_message_content || '暂无消息';
                const lastMessageTime = contract.last_message_time ? new Date(contract.last_message_time).toLocaleString('zh-CN') : '';
                
                return `
                    <div class="chat-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" 
                         onclick="openChat('${user.id}', '${userName}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                <i class="fa fa-user text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">${userName}</h4>
                                <p class="text-sm text-gray-600 truncate">${lastMessage}</p>
                                <p class="text-xs text-gray-500">${lastMessageTime}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            chatList.innerHTML = chatItems;
        }

        // 打开聊天窗口
        function openChat(userId, userName) {
            currentChatUser = { id: userId, name: userName };
            
            // 显示聊天窗口
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('no-chat-selected').classList.add('hidden');
            document.getElementById('chat-title').textContent = `与 ${userName} 聊天`;
            
            // 加载聊天历史
            loadChatHistory(userId);
            
            addTestResult(`✅ 已打开与 ${userName} 的聊天窗口`, 'success');
        }

        // 关闭聊天窗口
        function closeChatWindow() {
            document.getElementById('chat-window').classList.add('hidden');
            document.getElementById('no-chat-selected').classList.remove('hidden');
            currentChatUser = null;
            
            // 清空消息显示区域
            document.getElementById('chat-messages').innerHTML = '<p class="text-gray-500 text-center py-8">开始新的对话</p>';
            document.getElementById('chat-input').value = '';
            
            addTestResult('✅ 聊天窗口已关闭', 'info');
        }

        // 加载聊天历史
        async function loadChatHistory(userId) {
            if (!caregiverId) return;

            try {
                const response = await fetch(`/api/chat/history/${userId}?user_id=${caregiverId}&user_type=caregiver&limit=100`);
                const data = await response.json();

                if (data.success) {
                    const messages = data.data.messages || [];
                    displayChatHistory(messages);
                    addTestResult(`✅ 成功加载 ${messages.length} 条聊天记录`, 'success');
                } else {
                    addTestResult(`❌ 加载聊天历史失败: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`❌ 加载聊天历史失败: ${error.message}`, 'error');
            }
        }

        // 显示聊天历史
        function displayChatHistory(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p class="text-gray-500 text-center py-8">开始新的对话</p>';
                return;
            }

            const messagesHtml = messages.map(message => {
                const isOwnMessage = message.sender_id == caregiverId;
                const messageClass = isOwnMessage ? 'ml-auto bg-primary text-white' : 'mr-auto bg-gray-200 text-gray-800';
                
                return `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3">
                        <div class="max-w-xs ${messageClass} rounded-lg p-3">
                            <p class="text-sm">${message.content}</p>
                            <p class="text-xs ${isOwnMessage ? 'text-white/70' : 'text-gray-500'} mt-1">
                                ${new Date(message.timestamp).toLocaleString('zh-CN')}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            messagesContainer.innerHTML = messagesHtml;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 发送消息
        async function sendMessage() {
            if (!currentChatUser || !caregiverId) {
                addTestResult('❌ 无法发送消息：聊天未开始或护工未登录', 'error');
                return;
            }

            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (!content) {
                addTestResult('❌ 请输入消息内容', 'warning');
                return;
            }

            // 构造消息
            const message = {
                sender_id: caregiverId,
                sender_type: 'caregiver',
                sender_name: caregiverName,
                recipient_id: currentChatUser.id,
                recipient_type: 'user',
                content: content,
                type: 'text'
            };

            try {
                addTestResult('🔄 正在发送消息...', 'info');
                
                // 发送消息到后端
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(message)
                });

                const data = await response.json();

                if (data.success) {
                    // 添加到本地显示
                    addMessageToDisplay({
                        ...message,
                        timestamp: new Date().toISOString()
                    });

                    // 清空输入框
                    input.value = '';

                    addTestResult('✅ 消息发送成功', 'success');
                } else {
                    addTestResult(`❌ 发送消息失败: ${data.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`❌ 发送消息失败: ${error.message}`, 'error');
            }
        }

        // 添加消息到显示区域
        function addMessageToDisplay(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const isOwnMessage = message.sender_id == caregiverId;
            const messageClass = isOwnMessage ? 'ml-auto bg-primary text-white' : 'mr-auto bg-gray-200 text-gray-800';
            
            const messageHtml = `
                <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3">
                    <div class="max-w-xs ${messageClass} rounded-lg p-3">
                        <p class="text-sm">${message.content}</p>
                        <p class="text-xs ${isOwnMessage ? 'text-white/70' : 'text-gray-500'} mt-1">
                            ${new Date(message.timestamp).toLocaleString('zh-CN')}
                        </p>
                    </div>
                </div>
            `;

            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 处理接收到的消息
        function handleIncomingMessage(data) {
            // 如果当前聊天窗口打开且消息来自当前聊天的用户
            if (currentChatUser && data.sender_id == currentChatUser.id) {
                addMessageToDisplay(data);
            }
        }

        // 添加测试结果
        function addTestResult(message, type = 'info') {
            const resultsContainer = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const resultHtml = `
                <p class="${colorClass}">
                    [${timestamp}] ${message}
                </p>
            `;
            
            resultsContainer.insertAdjacentHTML('beforeend', resultHtml);
            
            // 限制显示结果数量
            const results = resultsContainer.querySelectorAll('p');
            if (results.length > 20) {
                results[0].remove();
            }
        }

        // 绑定回车键发送消息
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'chat-input') {
                sendMessage();
            }
        });

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('🚀 护工聊天功能测试页面已加载', 'info');
        });
    </script>
</body>
</html>
