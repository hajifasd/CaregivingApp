<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¤å·¥æœç´¢æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">æŠ¤å·¥æœç´¢æµ‹è¯•é¡µé¢</h1>
        
        <!-- æµ‹è¯•çŠ¶æ€ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•çŠ¶æ€</h2>
            <div id="test-status" class="space-y-2">
                <div class="text-gray-500">å‡†å¤‡æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- æŠ¤å·¥æ•°æ®æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-4">æŠ¤å·¥æ•°æ®æµ‹è¯•</h3>
            <button onclick="testCaregiverData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                æµ‹è¯•æŠ¤å·¥æ•°æ®
            </button>
            <div id="caregiver-data-result" class="mt-4"></div>
        </div>
        
        <!-- æŠ¤å·¥æœç´¢æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-4">æŠ¤å·¥æœç´¢æµ‹è¯•</h3>
            <div class="mb-4">
                <input type="text" id="search-keyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." 
                       class="w-full p-3 border border-gray-300 rounded-lg">
                <button onclick="testCaregiverSearch()" class="mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æœç´¢æŠ¤å·¥
                </button>
            </div>
            <div id="search-result" class="mt-4"></div>
        </div>
        
        <!-- æ¨¡æ‹Ÿç”¨æˆ·ç™»å½• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-4">æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</h3>
            <button onclick="simulateUserLogin()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
            </button>
            <div id="login-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        function addLog(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            const logDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            let colorClass = 'text-gray-500';
            if (type === 'success') colorClass = 'text-green-600';
            if (type === 'error') colorClass = 'text-red-600';
            if (type === 'warning') colorClass = 'text-yellow-600';
            
            logDiv.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            statusDiv.appendChild(logDiv);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        // æµ‹è¯•æŠ¤å·¥æ•°æ®
        async function testCaregiverData() {
            addLog('ğŸ”§ æµ‹è¯•æŠ¤å·¥æ•°æ®...', 'info');
            
            try {
                const response = await fetch('/api/test/caregivers');
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… æŠ¤å·¥æ•°æ®æµ‹è¯•æˆåŠŸ`, 'success');
                    addLog(`ğŸ“Š æŠ¤å·¥æ€»æ•°: ${result.data.total_caregivers}`, 'info');
                    
                    const resultDiv = document.getElementById('caregiver-data-result');
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">æŠ¤å·¥æ•°æ®æ­£å¸¸</h4>
                            <p class="text-green-700">æŠ¤å·¥æ€»æ•°: ${result.data.total_caregivers}</p>
                            ${result.data.sample_caregivers.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium">ç¤ºä¾‹æŠ¤å·¥:</p>
                                    <ul class="list-disc list-inside text-sm">
                                        ${result.data.sample_caregivers.map(c => `<li>${c.name} (${c.phone})</li>`).join('')}
                                    </ul>
                                </div>
                            ` : '<p class="text-yellow-600">âš ï¸ æ²¡æœ‰æ‰¾åˆ°æŠ¤å·¥æ•°æ®</p>'}
                        </div>
                    `;
                } else {
                    addLog(`âŒ æŠ¤å·¥æ•°æ®æµ‹è¯•å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ æŠ¤å·¥æ•°æ®æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•æŠ¤å·¥æœç´¢
        async function testCaregiverSearch() {
            const keyword = document.getElementById('search-keyword').value.trim();
            if (!keyword) {
                addLog('âš ï¸ è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }
            
            addLog(`ğŸ” æœç´¢æŠ¤å·¥: "${keyword}"`, 'info');
            
            try {
                const response = await fetch(`/api/user/caregivers/search?keyword=${encodeURIComponent(keyword)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('user_token')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${result.data.length} ä¸ªæŠ¤å·¥`, 'success');
                    
                    const resultDiv = document.getElementById('search-result');
                    if (result.data.length > 0) {
                        resultDiv.innerHTML = `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800">æœç´¢ç»“æœ</h4>
                                <div class="space-y-2 mt-2">
                                    ${result.data.map(caregiver => `
                                        <div class="flex items-center p-2 bg-white rounded border">
                                            <img src="${caregiver.avatar}" alt="${caregiver.name}" class="w-8 h-8 rounded-full mr-3">
                                            <div>
                                                <div class="font-medium">${caregiver.name}</div>
                                                <div class="text-sm text-gray-500">${caregiver.phone}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800">æœªæ‰¾åˆ°åŒ¹é…çš„æŠ¤å·¥</h4>
                                <p class="text-yellow-700">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</p>
                            </div>
                        `;
                    }
                } else {
                    addLog(`âŒ æœç´¢å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ æœç´¢å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
        function simulateUserLogin() {
            addLog('ğŸ” æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•...', 'info');
            
            // è®¾ç½®æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯
            const userInfo = {
                id: 21,
                name: 'æµ‹è¯•ç”¨æˆ·',
                email: 'test@example.com'
            };
            
            localStorage.setItem('user_info', JSON.stringify(userInfo));
            localStorage.setItem('user_token', 'test-token-for-caregiver-search');
            
            addLog('âœ… æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æˆåŠŸ', 'success');
            
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = `
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-800">ç™»å½•æˆåŠŸ</h4>
                    <p class="text-green-700">ç”¨æˆ·ID: ${userInfo.id}</p>
                    <p class="text-green-700">ç”¨æˆ·å: ${userInfo.name}</p>
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“‹ æŠ¤å·¥æœç´¢æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            testCaregiverData();
        });
    </script>
</body>
</html>
