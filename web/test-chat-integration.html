<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天功能集成测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">聊天功能集成测试</h1>
        
        <!-- 测试说明 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">测试说明</h2>
            <p class="text-blue-700">
                本页面用于测试护工仪表板和用户消息页面的聊天功能集成。
                请按照以下步骤进行测试：
            </p>
            <ol class="list-decimal list-inside mt-2 text-blue-700 space-y-1">
                <li>启动后端服务：<code class="bg-blue-100 px-2 py-1 rounded">cd back && python app.py</code></li>
                <li>测试护工仪表板聊天功能：访问 <a href="/caregiver/dashboard" class="text-blue-600 underline">护工仪表板</a></li>
                <li>测试用户消息页面聊天功能：访问 <a href="/user/user-messages.html" class="text-blue-600 underline">用户消息中心</a></li>
                <li>验证WebSocket连接和消息传递</li>
            </ol>
        </div>

        <!-- 功能测试区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 护工端测试 -->
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4 text-green-600">护工端聊天功能测试</h2>
                <div class="space-y-3">
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="font-semibold text-green-800">✅ 已实现功能</h3>
                        <ul class="text-sm text-green-700 mt-2 space-y-1">
                            <li>• 在护工仪表板消息中心集成聊天功能</li>
                            <li>• 显示聘用合同中的用户聊天列表</li>
                            <li>• 实时聊天窗口和消息发送</li>
                            <li>• WebSocket连接和消息接收</li>
                            <li>• 聊天历史记录加载</li>
                        </ul>
                    </div>
                    
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-semibold text-blue-800">🔍 测试要点</h3>
                        <ul class="text-sm text-blue-700 mt-2 space-y-1">
                            <li>• 登录护工账户，进入消息中心</li>
                            <li>• 检查聊天列表是否正确显示</li>
                            <li>• 测试聊天窗口的打开和关闭</li>
                            <li>• 验证消息发送和接收功能</li>
                            <li>• 检查聊天历史是否正确加载</li>
                        </ul>
                    </div>
                    
                    <a href="/caregiver/dashboard" class="block w-full text-center bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        进入护工仪表板测试
                    </a>
                </div>
            </div>

            <!-- 用户端测试 -->
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4 text-blue-600">用户端聊天功能测试</h2>
                <div class="space-y-3">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-semibold text-blue-800">✅ 已实现功能</h3>
                        <ul class="text-sm text-blue-700 mt-2 space-y-1">
                            <li>• 在用户消息中心集成聊天功能</li>
                            <li>• 查找护工并建立交流</li>
                            <li>• 实时聊天窗口和消息发送</li>
                            <li>• WebSocket连接和消息接收</li>
                            <li>• 最近联系人列表更新</li>
                        </ul>
                    </div>
                    
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="font-semibold text-green-800">🔍 测试要点</h3>
                        <ul class="text-sm text-green-700 mt-2 space-y-1">
                            <li>• 登录用户账户，进入消息中心</li>
                            <li>• 点击"查找护工"按钮</li>
                            <li>• 搜索护工并开始聊天</li>
                            <li>• 测试消息发送和接收</li>
                            <li>• 验证最近联系人列表更新</li>
                        </ul>
                    </div>
                    
                    <a href="/user/user-messages.html" class="block w-full text-center bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        进入用户消息中心测试
                    </a>
                </div>
            </div>
        </div>

        <!-- 技术架构说明 -->
        <div class="bg-white rounded-xl p-6 shadow-sm mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">技术架构说明</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">后端架构</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• Flask + SocketIO WebSocket服务器</li>
                        <li>• 消息服务 (MessageService)</li>
                        <li>• 聊天模型 (ChatMessage, ChatConversation)</li>
                        <li>• 聊天API (chat_bp)</li>
                        <li>• 聘用合同API (employment_contract)</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">前端架构</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• Socket.IO客户端连接</li>
                        <li>• 护工仪表板聊天集成</li>
                        <li>• 用户消息中心聊天集成</li>
                        <li>• 实时消息处理</li>
                        <li>• 聊天历史管理</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 测试状态 -->
        <div class="bg-white rounded-xl p-6 shadow-sm mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">测试状态检查</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 border rounded-lg">
                    <div id="backend-status" class="text-2xl mb-2">⏳</div>
                    <h3 class="font-semibold">后端服务</h3>
                    <p class="text-sm text-gray-600">检查中...</p>
                </div>
                <div class="text-center p-4 border rounded-lg">
                    <div id="websocket-status" class="text-2xl mb-2">⏳</div>
                    <h3 class="font-semibold">WebSocket</h3>
                    <p class="text-sm text-gray-600">检查中...</p>
                </div>
                <div class="text-center p-4 border rounded-lg">
                    <div id="database-status" class="text-2xl mb-2">⏳</div>
                    <h3 class="font-semibold">数据库</h3>
                    <p class="text-sm text-gray-600">检查中...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 测试状态检查
        async function checkBackendStatus() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    document.getElementById('backend-status').textContent = '✅';
                    document.querySelector('#backend-status').nextElementSibling.nextElementSibling.textContent = '运行正常';
                } else {
                    document.getElementById('backend-status').textContent = '❌';
                    document.querySelector('#backend-status').nextElementSibling.nextElementSibling.textContent = '连接失败';
                }
            } catch (error) {
                document.getElementById('backend-status').textContent = '❌';
                document.querySelector('#backend-status').nextElementSibling.nextElementSibling.textContent = '无法连接';
            }
        }

        async function checkWebSocketStatus() {
            try {
                const socket = io('http://localhost:8000');
                
                socket.on('connect', () => {
                    document.getElementById('websocket-status').textContent = '✅';
                    document.querySelector('#websocket-status').nextElementSibling.nextElementSibling.textContent = '连接成功';
                    socket.disconnect();
                });
                
                socket.on('connect_error', () => {
                    document.getElementById('websocket-status').textContent = '❌';
                    document.querySelector('#websocket-status').nextElementSibling.nextElementSibling.textContent = '连接失败';
                });
                
                // 5秒后超时
                setTimeout(() => {
                    if (document.getElementById('websocket-status').textContent === '⏳') {
                        document.getElementById('websocket-status').textContent = '❌';
                        document.querySelector('#websocket-status').nextElementSibling.nextElementSibling.textContent = '连接超时';
                    }
                }, 5000);
            } catch (error) {
                document.getElementById('websocket-status').textContent = '❌';
                document.querySelector('#websocket-status').nextElementSibling.nextElementSibling.textContent = '初始化失败';
            }
        }

        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/health/database');
                if (response.ok) {
                    document.getElementById('database-status').textContent = '✅';
                    document.querySelector('#database-status').nextElementSibling.nextElementSibling.textContent = '连接正常';
                } else {
                    document.getElementById('database-status').textContent = '❌';
                    document.querySelector('#database-status').nextElementSibling.nextElementSibling.textContent = '连接异常';
                }
            } catch (error) {
                document.getElementById('database-status').textContent = '❌';
                document.querySelector('#database-status').nextElementSibling.nextElementSibling.textContent = '无法连接';
            }
        }

        // 页面加载完成后开始检查
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkBackendStatus();
                checkWebSocketStatus();
                checkDatabaseStatus();
            }, 1000);
        });
    </script>
</body>
</html>
