<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天功能测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6">聊天功能测试</h1>
        
        <!-- 连接状态 -->
        <div class="mb-4 p-3 rounded-lg" id="status">
            <span class="font-medium">状态:</span>
            <span id="connection-status" class="ml-2 text-red-600">未连接</span>
        </div>
        
        <!-- 消息区域 -->
        <div class="mb-4 p-4 bg-gray-50 rounded-lg h-64 overflow-y-auto" id="messages">
            <p class="text-gray-500 text-center">等待连接...</p>
        </div>
        
        <!-- 输入区域 -->
        <div class="flex gap-2">
            <input type="text" id="message-input" placeholder="输入消息..." 
                   class="flex-1 p-2 border border-gray-300 rounded-lg">
            <button id="send-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                发送
            </button>
        </div>
        
        <!-- 测试按钮 -->
        <div class="mt-4 flex gap-2">
            <button id="test-connect" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                测试连接
            </button>
            <button id="test-message" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                测试消息
            </button>
        </div>
    </div>

    <script>
        let socket = null;
        
        // 初始化Socket.IO连接
        function initSocket() {
            try {
                console.log('正在连接Socket.IO服务器...');
                socket = io('http://localhost:8000');
                
                socket.on('connect', () => {
                    console.log('✅ 连接成功');
                    updateStatus('已连接', 'text-green-600');
                    addMessage('系统', '连接成功！', 'system');
                });
                
                socket.on('disconnect', () => {
                    console.log('❌ 连接断开');
                    updateStatus('连接断开', 'text-red-600');
                    addMessage('系统', '连接断开', 'system');
                });
                
                socket.on('connect_error', (error) => {
                    console.error('连接错误:', error);
                    updateStatus('连接错误', 'text-red-600');
                    addMessage('系统', `连接错误: ${error.message}`, 'error');
                });
                
                // 监听自定义事件
                socket.on('message_received', (data) => {
                    console.log('收到消息:', data);
                    addMessage('服务器', data.content || '收到消息', 'received');
                });
                
            } catch (error) {
                console.error('Socket.IO初始化失败:', error);
                updateStatus('初始化失败', 'text-red-600');
                addMessage('系统', `初始化失败: ${error.message}`, 'error');
            }
        }
        
        // 更新状态
        function updateStatus(text, colorClass) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = text;
            statusElement.className = `ml-2 ${colorClass}`;
        }
        
        // 添加消息
        function addMessage(sender, content, type = 'normal') {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            
            let bgColor = 'bg-white';
            let textColor = 'text-gray-800';
            
            if (type === 'system') {
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
            } else if (type === 'received') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
            }
            
            messageElement.className = `p-2 mb-2 rounded ${bgColor} ${textColor}`;
            messageElement.innerHTML = `
                <span class="font-medium">${sender}:</span>
                <span class="ml-2">${content}</span>
                <span class="ml-2 text-xs text-gray-500">${new Date().toLocaleTimeString()}</span>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 发送消息
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!socket || !socket.connected) {
                addMessage('系统', '未连接到服务器', 'error');
                return;
            }
            
            // 发送消息到服务器
            socket.emit('send_message', {
                content: message,
                timestamp: new Date().toISOString()
            });
            
            addMessage('我', message, 'normal');
            input.value = '';
        }
        
        // 测试连接
        function testConnection() {
            if (socket && socket.connected) {
                addMessage('系统', '连接正常', 'system');
            } else {
                addMessage('系统', '连接异常', 'error');
            }
        }
        
        // 测试消息
        function testMessage() {
            if (socket && socket.connected) {
                socket.emit('test_message', { message: '这是一条测试消息' });
                addMessage('系统', '发送测试消息', 'system');
            } else {
                addMessage('系统', '无法发送测试消息，连接异常', 'error');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定事件
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('test-connect').addEventListener('click', testConnection);
            document.getElementById('test-message').addEventListener('click', testMessage);
            
            // 回车发送
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 初始化Socket连接
            setTimeout(initSocket, 1000);
        });
    </script>
</body>
</html>
