<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ä»¶ä¾èµ–æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/message-format-utils.js"></script>
    <script src="/js/unified-chat-manager.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">ç»„ä»¶ä¾èµ–æµ‹è¯•é¡µé¢</h1>
        
        <!-- ç»„ä»¶çŠ¶æ€ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">ç»„ä»¶åŠ è½½çŠ¶æ€</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold" id="unified-chat-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="message-format-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">æ¶ˆæ¯æ ¼å¼å·¥å…·</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="old-components-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">æ—§ç»„ä»¶çŠ¶æ€</div>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">åŠŸèƒ½æµ‹è¯•</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium mb-3">èŠå¤©åŠŸèƒ½æµ‹è¯•</h3>
                    <div class="space-y-2">
                        <button onclick="testUnifiedChatManager()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨
                        </button>
                        <button onclick="testMessageFormat()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·
                        </button>
                        <button onclick="testChatWindow()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                            æµ‹è¯•èŠå¤©çª—å£
                        </button>
                        <button onclick="testSocketConnection()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                            æµ‹è¯•Socketè¿æ¥
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-3">ç»„ä»¶å†²çªæ£€æµ‹</h3>
                    <div class="space-y-2">
                        <button onclick="checkOldComponents()" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            æ£€æŸ¥æ—§ç»„ä»¶
                        </button>
                        <button onclick="checkGlobalVariables()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                            æ£€æŸ¥å…¨å±€å˜é‡
                        </button>
                        <button onclick="checkMemoryUsage()" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
                            æ£€æŸ¥å†…å­˜ä½¿ç”¨
                        </button>
                        <button onclick="runPerformanceTest()" class="w-full bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600">
                            æ€§èƒ½æµ‹è¯•
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•ç»“æœ</h2>
            <div id="test-results" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
                <div class="text-gray-500">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- ç»„ä»¶ä¿¡æ¯ -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">ç»„ä»¶ä¿¡æ¯</h2>
            <div id="component-info" class="bg-gray-50 p-4 rounded text-sm font-mono h-48 overflow-y-auto">
                <div class="text-gray-500">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹ç»„ä»¶ä¿¡æ¯...</div>
            </div>
        </div>
    </div>

    <script>
        const testResults = document.getElementById('test-results');
        const componentInfo = document.getElementById('component-info');
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const logDiv = document.createElement('div');
            logDiv.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            testResults.appendChild(logDiv);
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        // æ›´æ–°ç»„ä»¶çŠ¶æ€
        function updateComponentStatus() {
            // æ£€æŸ¥ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨
            const unifiedChatStatus = document.getElementById('unified-chat-status');
            if (window.unifiedChatManager) {
                unifiedChatStatus.textContent = 'âœ… å·²åŠ è½½';
                unifiedChatStatus.className = 'text-2xl font-bold text-green-600';
            } else {
                unifiedChatStatus.textContent = 'âŒ æœªåŠ è½½';
                unifiedChatStatus.className = 'text-2xl font-bold text-red-600';
            }
            
            // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼å·¥å…·
            const messageFormatStatus = document.getElementById('message-format-status');
            if (window.MessageFormatUtils) {
                messageFormatStatus.textContent = 'âœ… å·²åŠ è½½';
                messageFormatStatus.className = 'text-2xl font-bold text-green-600';
            } else {
                messageFormatStatus.textContent = 'âŒ æœªåŠ è½½';
                messageFormatStatus.className = 'text-2xl font-bold text-red-600';
            }
            
            // æ£€æŸ¥æ—§ç»„ä»¶
            const oldComponentsStatus = document.getElementById('old-components-status');
            const hasOldComponents = window.ChatWindow || window.ChatManager || window.EnhancedChatManager;
            if (hasOldComponents) {
                oldComponentsStatus.textContent = 'âš ï¸ å­˜åœ¨æ—§ç»„ä»¶';
                oldComponentsStatus.className = 'text-2xl font-bold text-yellow-600';
            } else {
                oldComponentsStatus.textContent = 'âœ… å·²æ¸…ç†';
                oldComponentsStatus.className = 'text-2xl font-bold text-green-600';
            }
        }
        
        // æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨
        function testUnifiedChatManager() {
            addLog('ğŸ”§ æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨...', 'info');
            
            if (!window.unifiedChatManager) {
                addLog('âŒ ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            try {
                // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                const manager = window.unifiedChatManager;
                
                addLog('âœ… ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨å®ä¾‹å­˜åœ¨', 'success');
                addLog(`ğŸ“Š ç”¨æˆ·ä¿¡æ¯: ${manager.userInfo ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`, 'info');
                addLog(`ğŸ”Œ SocketçŠ¶æ€: ${manager.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'info');
                addLog(`ğŸ’¬ èŠå¤©çª—å£: ${manager.isOpen ? 'å·²æ‰“å¼€' : 'å·²å…³é—­'}`, 'info');
                
                // æµ‹è¯•æ–¹æ³•
                const methods = ['openChat', 'closeChat', 'sendMessage', 'loadUserInfo'];
                methods.forEach(method => {
                    if (typeof manager[method] === 'function') {
                        addLog(`âœ… æ–¹æ³• ${method} å­˜åœ¨`, 'success');
                    } else {
                        addLog(`âŒ æ–¹æ³• ${method} ä¸å­˜åœ¨`, 'error');
                    }
                });
                
            } catch (error) {
                addLog('âŒ ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·
        function testMessageFormat() {
            addLog('ğŸ”§ æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·...', 'info');
            
            if (!window.MessageFormatUtils) {
                addLog('âŒ æ¶ˆæ¯æ ¼å¼å·¥å…·æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            try {
                // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                const utils = window.MessageFormatUtils;
                
                addLog('âœ… æ¶ˆæ¯æ ¼å¼å·¥å…·å·²åŠ è½½', 'success');
                
                // æµ‹è¯•æ–¹æ³•
                const methods = ['standardizeMessageData', 'validateMessageData', 'buildSendMessageData', 'getCurrentUserInfo'];
                methods.forEach(method => {
                    if (typeof utils[method] === 'function') {
                        addLog(`âœ… æ–¹æ³• ${method} å­˜åœ¨`, 'success');
                    } else {
                        addLog(`âŒ æ–¹æ³• ${method} ä¸å­˜åœ¨`, 'error');
                    }
                });
                
                // æµ‹è¯•æ¶ˆæ¯æ„å»º
                const testMessage = utils.buildSendMessageData(1, 'æµ‹è¯•æ¶ˆæ¯', { recipientType: 'user' });
                addLog(`ğŸ“ æµ‹è¯•æ¶ˆæ¯æ„å»º: ${JSON.stringify(testMessage)}`, 'info');
                
                // æµ‹è¯•æ¶ˆæ¯éªŒè¯
                const validation = utils.validateMessageData(testMessage);
                addLog(`âœ… æ¶ˆæ¯éªŒè¯: ${validation.isValid ? 'é€šè¿‡' : 'å¤±è´¥'}`, validation.isValid ? 'success' : 'error');
                
            } catch (error) {
                addLog('âŒ æ¶ˆæ¯æ ¼å¼å·¥å…·æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•èŠå¤©çª—å£
        function testChatWindow() {
            addLog('ğŸ”§ æµ‹è¯•èŠå¤©çª—å£...', 'info');
            
            if (!window.unifiedChatManager) {
                addLog('âŒ ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            try {
                const manager = window.unifiedChatManager;
                
                // æµ‹è¯•èŠå¤©çª—å£åˆ›å»º
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) {
                    addLog('âœ… èŠå¤©çª—å£DOMå…ƒç´ å­˜åœ¨', 'success');
                } else {
                    addLog('âš ï¸ èŠå¤©çª—å£DOMå…ƒç´ ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º', 'warning');
                    manager.createChatWindow();
                }
                
                // æµ‹è¯•æ‰“å¼€èŠå¤©
                const testContact = {
                    id: 1,
                    name: 'æµ‹è¯•è”ç³»äºº',
                    type: 'user',
                    online: true
                };
                
                manager.openChat(testContact);
                addLog('âœ… èŠå¤©çª—å£æ‰“å¼€æµ‹è¯•å®Œæˆ', 'success');
                
                // å…³é—­èŠå¤©
                setTimeout(() => {
                    manager.closeChat();
                    addLog('âœ… èŠå¤©çª—å£å…³é—­æµ‹è¯•å®Œæˆ', 'success');
                }, 1000);
                
            } catch (error) {
                addLog('âŒ èŠå¤©çª—å£æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•Socketè¿æ¥
        function testSocketConnection() {
            addLog('ğŸ”§ æµ‹è¯•Socketè¿æ¥...', 'info');
            
            if (!window.unifiedChatManager) {
                addLog('âŒ ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            try {
                const manager = window.unifiedChatManager;
                
                if (manager.socket) {
                    addLog('âœ… Socketå®ä¾‹å­˜åœ¨', 'success');
                    addLog(`ğŸ”Œ è¿æ¥çŠ¶æ€: ${manager.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'info');
                    
                    if (manager.isConnected) {
                        addLog('âœ… Socketè¿æ¥æ­£å¸¸', 'success');
                    } else {
                        addLog('âš ï¸ Socketæœªè¿æ¥ï¼Œå°è¯•é‡è¿...', 'warning');
                        manager.initSocket();
                    }
                } else {
                    addLog('âŒ Socketå®ä¾‹ä¸å­˜åœ¨', 'error');
                }
                
            } catch (error) {
                addLog('âŒ Socketè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ£€æŸ¥æ—§ç»„ä»¶
        function checkOldComponents() {
            addLog('ğŸ” æ£€æŸ¥æ—§ç»„ä»¶...', 'info');
            
            const oldComponents = {
                'ChatWindow': window.ChatWindow,
                'ChatManager': window.ChatManager,
                'EnhancedChatManager': window.EnhancedChatManager,
                'chatWindow': window.chatWindow,
                'chatManager': window.chatManager,
                'enhancedChatManager': window.enhancedChatManager
            };
            
            let foundOldComponents = false;
            
            Object.entries(oldComponents).forEach(([name, component]) => {
                if (component) {
                    addLog(`âš ï¸ å‘ç°æ—§ç»„ä»¶: ${name}`, 'warning');
                    foundOldComponents = true;
                } else {
                    addLog(`âœ… æ—§ç»„ä»¶å·²æ¸…ç†: ${name}`, 'success');
                }
            });
            
            if (!foundOldComponents) {
                addLog('âœ… æ‰€æœ‰æ—§ç»„ä»¶å·²æ¸…ç†', 'success');
            }
        }
        
        // æ£€æŸ¥å…¨å±€å˜é‡
        function checkGlobalVariables() {
            addLog('ğŸ” æ£€æŸ¥å…¨å±€å˜é‡...', 'info');
            
            const globalVars = Object.keys(window).filter(key => 
                key.includes('chat') || key.includes('Chat') || key.includes('message') || key.includes('Message')
            );
            
            addLog(`ğŸ“Š æ‰¾åˆ° ${globalVars.length} ä¸ªç›¸å…³å…¨å±€å˜é‡:`, 'info');
            globalVars.forEach(varName => {
                const value = window[varName];
                const type = typeof value;
                addLog(`  - ${varName}: ${type}`, 'info');
            });
        }
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
        function checkMemoryUsage() {
            addLog('ğŸ” æ£€æŸ¥å†…å­˜ä½¿ç”¨...', 'info');
            
            if (performance.memory) {
                const memory = performance.memory;
                addLog(`ğŸ“Š å·²ä½¿ç”¨å†…å­˜: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                addLog(`ğŸ“Š æ€»å†…å­˜: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                addLog(`ğŸ“Š å†…å­˜é™åˆ¶: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`, 'info');
            } else {
                addLog('âš ï¸ æ— æ³•è·å–å†…å­˜ä¿¡æ¯', 'warning');
            }
        }
        
        // æ€§èƒ½æµ‹è¯•
        function runPerformanceTest() {
            addLog('âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•...', 'info');
            
            const startTime = performance.now();
            
            // æµ‹è¯•ç»„ä»¶åˆå§‹åŒ–æ—¶é—´
            const initStart = performance.now();
            if (window.unifiedChatManager) {
                const initEnd = performance.now();
                addLog(`â±ï¸ ç»„ä»¶åˆå§‹åŒ–æ—¶é—´: ${(initEnd - initStart).toFixed(2)} ms`, 'info');
            }
            
            // æµ‹è¯•æ¶ˆæ¯å¤„ç†æ€§èƒ½
            const messageStart = performance.now();
            for (let i = 0; i < 1000; i++) {
                if (window.MessageFormatUtils) {
                    window.MessageFormatUtils.buildSendMessageData(i, `æµ‹è¯•æ¶ˆæ¯${i}`, { recipientType: 'user' });
                }
            }
            const messageEnd = performance.now();
            addLog(`â±ï¸ 1000æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´: ${(messageEnd - messageStart).toFixed(2)} ms`, 'info');
            
            const endTime = performance.now();
            addLog(`â±ï¸ æ€»æµ‹è¯•æ—¶é—´: ${(endTime - startTime).toFixed(2)} ms`, 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“‹ ç»„ä»¶ä¾èµ–æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            updateComponentStatus();
        });
    </script>
</body>
</html>
