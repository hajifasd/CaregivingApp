<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯åŠŸèƒ½ç»¼åˆæµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // ç¡®ä¿Socket.IOåŠ è½½å®Œæˆåå†åŠ è½½å…¶ä»–è„šæœ¬
        window.addEventListener('load', function() {
            console.log('ğŸ“‹ å¼€å§‹åŠ è½½ä¾èµ–è„šæœ¬...');
            
            // åŠ¨æ€åŠ è½½è„šæœ¬
            const scripts = [
                '/js/config.js',
                '/js/message-format-utils.js', 
                '/js/message-loader.js',
                '/js/unified-chat-manager.js'
            ];
            
            let loadedCount = 0;
            scripts.forEach((src, index) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = function() {
                    loadedCount++;
                    console.log(`âœ… è„šæœ¬åŠ è½½å®Œæˆ: ${src} (${loadedCount}/${scripts.length})`);
                    
                    if (loadedCount === scripts.length) {
                        console.log('ğŸ‰ æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆï¼');
                        // è§¦å‘æµ‹è¯•
                        if (typeof runAllTests === 'function') {
                            setTimeout(runAllTests, 500);
                        }
                    }
                };
                script.onerror = function() {
                    console.error(`âŒ è„šæœ¬åŠ è½½å¤±è´¥: ${src}`);
                };
                document.head.appendChild(script);
            });
        });
    </script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">æ¶ˆæ¯åŠŸèƒ½ç»¼åˆæµ‹è¯•é¡µé¢</h1>
        
        <!-- æµ‹è¯•çŠ¶æ€æ€»è§ˆ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•çŠ¶æ€æ€»è§ˆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold" id="overall-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">æ€»ä½“çŠ¶æ€</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="components-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">ç»„ä»¶çŠ¶æ€</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="api-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">APIçŠ¶æ€</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="socket-status">æ£€æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-600">SocketçŠ¶æ€</div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
                <div class="space-y-3">
                    <button onclick="testLocalStorage()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æµ‹è¯•localStorageå­—æ®µå
                    </button>
                    <button onclick="testMessageFormat()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·
                    </button>
                    <button onclick="testMessageLoader()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        æµ‹è¯•æ¶ˆæ¯åŠ è½½å·¥å…·
                    </button>
                    <button onclick="testUnifiedChatManager()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨
                    </button>
                </div>
            </div>
            
            <!-- APIåŠŸèƒ½æµ‹è¯• -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">APIåŠŸèƒ½æµ‹è¯•</h3>
                <div class="space-y-3">
                    <button onclick="testDatabaseConnection()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                        æµ‹è¯•æ•°æ®åº“è¿æ¥
                    </button>
                    <button onclick="testMessageAPI()" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
                        æµ‹è¯•æ¶ˆæ¯API
                    </button>
                    <button onclick="testConversationAPI()" class="w-full bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600">
                        æµ‹è¯•å¯¹è¯API
                    </button>
                    <button onclick="testSocketConnection()" class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        æµ‹è¯•Socketè¿æ¥
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ç«¯åˆ°ç«¯æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-4">ç«¯åˆ°ç«¯æµ‹è¯•</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testUserWorkflow()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ç”¨æˆ·ç«¯å®Œæ•´æµç¨‹
                </button>
                <button onclick="testCaregiverWorkflow()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æŠ¤å·¥ç«¯å®Œæ•´æµç¨‹
                </button>
                <button onclick="testCrossPlatformMessaging()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    è·¨å¹³å°æ¶ˆæ¯æµ‹è¯•
                </button>
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-4">æµ‹è¯•ç»“æœ</h3>
            <div id="test-results" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
                <div class="text-gray-500">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4">æ€§èƒ½æµ‹è¯•</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="testPerformance()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    è¿è¡Œæ€§èƒ½æµ‹è¯•
                </button>
                <button onclick="testMemoryUsage()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    æ£€æŸ¥å†…å­˜ä½¿ç”¨
                </button>
            </div>
            <div id="performance-results" class="mt-4 bg-gray-50 p-4 rounded text-sm font-mono h-32 overflow-y-auto">
                <div class="text-gray-500">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹æ€§èƒ½æ•°æ®...</div>
            </div>
        </div>
    </div>

    <script>
        const testResults = document.getElementById('test-results');
        const performanceResults = document.getElementById('performance-results');
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const logDiv = document.createElement('div');
            logDiv.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            testResults.appendChild(logDiv);
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusMap = {
                'success': { text: 'âœ…', class: 'text-green-600' },
                'error': { text: 'âŒ', class: 'text-red-600' },
                'warning': { text: 'âš ï¸', class: 'text-yellow-600' },
                'info': { text: 'â„¹ï¸', class: 'text-blue-600' }
            };
            
            const statusInfo = statusMap[status] || statusMap['info'];
            element.textContent = statusInfo.text + ' ' + message;
            element.className = 'text-2xl font-bold ' + statusInfo.class;
        }
        
        // æµ‹è¯•localStorageå­—æ®µå
        async function testLocalStorage() {
            addLog('ğŸ”§ æµ‹è¯•localStorageå­—æ®µåä¸€è‡´æ€§...', 'info');
            
            try {
                const fields = ['user_info', 'caregiver_info', 'admin_info', 'user_token', 'caregiver_token', 'admin_token'];
                const results = {};
                
                fields.forEach(field => {
                    const value = localStorage.getItem(field);
                    results[field] = value ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';
                });
                
                addLog('ğŸ“Š localStorageå­—æ®µæ£€æŸ¥ç»“æœ:', 'info');
                Object.entries(results).forEach(([field, status]) => {
                    addLog(`  - ${field}: ${status}`, status === 'å­˜åœ¨' ? 'success' : 'warning');
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ—§å­—æ®µå
                const oldFields = ['userInfo', 'caregiverInfo', 'adminInfo'];
                const oldFieldResults = {};
                
                oldFields.forEach(field => {
                    const value = localStorage.getItem(field);
                    oldFieldResults[field] = value ? 'å­˜åœ¨ï¼ˆéœ€è¦æ¸…ç†ï¼‰' : 'ä¸å­˜åœ¨';
                });
                
                const hasOldFields = Object.values(oldFieldResults).some(status => status.includes('å­˜åœ¨'));
                if (hasOldFields) {
                    addLog('âš ï¸ å‘ç°æ—§å­—æ®µå:', 'warning');
                    Object.entries(oldFieldResults).forEach(([field, status]) => {
                        addLog(`  - ${field}: ${status}`, 'warning');
                    });
                } else {
                    addLog('âœ… æœªå‘ç°æ—§å­—æ®µåï¼ŒlocalStorageå­—æ®µåå·²ç»Ÿä¸€', 'success');
                }
                
            } catch (error) {
                addLog('âŒ localStorageæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·
        async function testMessageFormat() {
            addLog('ğŸ”§ æµ‹è¯•æ¶ˆæ¯æ ¼å¼å·¥å…·...', 'info');
            
            try {
                if (!window.MessageFormatUtils) {
                    throw new Error('MessageFormatUtilsæœªæ‰¾åˆ°');
                }
                
                // æµ‹è¯•æ¶ˆæ¯æ„å»º
                const testMessage = MessageFormatUtils.buildSendMessageData(1, 'æµ‹è¯•æ¶ˆæ¯', { recipientType: 'user' });
                addLog('âœ… æ¶ˆæ¯æ„å»ºæµ‹è¯•é€šè¿‡', 'success');
                
                // æµ‹è¯•æ¶ˆæ¯éªŒè¯
                const validation = MessageFormatUtils.validateMessageData(testMessage);
                if (validation.isValid) {
                    addLog('âœ… æ¶ˆæ¯éªŒè¯æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    addLog('âŒ æ¶ˆæ¯éªŒè¯æµ‹è¯•å¤±è´¥: ' + validation.errors.join(', '), 'error');
                }
                
                // æµ‹è¯•å­—æ®µæ ‡å‡†åŒ–
                const rawMessage = {
                    senderId: 1,
                    receiverId: 2,
                    content: 'æµ‹è¯•æ¶ˆæ¯',
                    type: 'text'
                };
                
                const standardized = MessageFormatUtils.standardizeMessageData(rawMessage);
                addLog('âœ… å­—æ®µæ ‡å‡†åŒ–æµ‹è¯•é€šè¿‡', 'success');
                addLog(`ğŸ“ æ ‡å‡†åŒ–ç»“æœ: ${JSON.stringify(standardized)}`, 'info');
                
            } catch (error) {
                addLog('âŒ æ¶ˆæ¯æ ¼å¼å·¥å…·æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯åŠ è½½å·¥å…·
        async function testMessageLoader() {
            addLog('ğŸ”§ æµ‹è¯•æ¶ˆæ¯åŠ è½½å·¥å…·...', 'info');
            
            try {
                if (!window.messageLoader) {
                    throw new Error('MessageLoaderæœªæ‰¾åˆ°');
                }
                
                // æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è·å–
                const userInfo = window.messageLoader.getCurrentUserInfo();
                addLog(`ğŸ“Š å½“å‰ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userInfo)}`, 'info');
                
                // æµ‹è¯•æ¶ˆæ¯å†å²è·å–
                try {
                    const messages = await window.messageLoader.getMessageHistory(1, 'user', { limit: 5 });
                    addLog(`âœ… æ¶ˆæ¯å†å²è·å–æˆåŠŸï¼Œå…± ${messages.length} æ¡æ¶ˆæ¯`, 'success');
                } catch (error) {
                    addLog('âš ï¸ æ¶ˆæ¯å†å²è·å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æœªç™»å½•ï¼‰: ' + error.message, 'warning');
                }
                
                // æµ‹è¯•å¯¹è¯åˆ—è¡¨è·å–
                try {
                    const conversations = await window.messageLoader.getConversations({ limit: 5 });
                    addLog(`âœ… å¯¹è¯åˆ—è¡¨è·å–æˆåŠŸï¼Œå…± ${conversations.length} ä¸ªå¯¹è¯`, 'success');
                } catch (error) {
                    addLog('âš ï¸ å¯¹è¯åˆ—è¡¨è·å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æœªç™»å½•ï¼‰: ' + error.message, 'warning');
                }
                
            } catch (error) {
                addLog('âŒ æ¶ˆæ¯åŠ è½½å·¥å…·æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨
        async function testUnifiedChatManager() {
            addLog('ğŸ”§ æµ‹è¯•ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨...', 'info');
            
            // æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€
            addLog(`ğŸ“‹ è„šæœ¬åŠ è½½æ£€æŸ¥:`, 'info');
            addLog(`- window.UnifiedChatManager: ${typeof window.UnifiedChatManager}`, 'info');
            addLog(`- window.unifiedChatManager: ${typeof window.unifiedChatManager}`, 'info');
            addLog(`- window.SERVER_CONFIG: ${typeof window.SERVER_CONFIG}`, 'info');
            addLog(`- window.MessageFormatUtils: ${typeof window.MessageFormatUtils}`, 'info');
            addLog(`- window.MessageLoader: ${typeof window.MessageLoader}`, 'info');
            
            try {
                if (!window.unifiedChatManager) {
                    throw new Error('UnifiedChatManageræœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥è„šæœ¬åŠ è½½é¡ºåº');
                }
                
                addLog('âœ… ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨å®ä¾‹å­˜åœ¨', 'success');
                addLog(`ğŸ“Š ç”¨æˆ·ä¿¡æ¯: ${window.unifiedChatManager.userInfo ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`, 'info');
                addLog(`ğŸ”Œ SocketçŠ¶æ€: ${window.unifiedChatManager.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'info');
                addLog(`ğŸ’¬ èŠå¤©çª—å£: ${window.unifiedChatManager.isOpen ? 'å·²æ‰“å¼€' : 'å·²å…³é—­'}`, 'info');
                
                // æµ‹è¯•æ–¹æ³•å­˜åœ¨æ€§
                const methods = ['openChat', 'closeChat', 'sendMessage', 'loadUserInfo', 'initSocket'];
                methods.forEach(method => {
                    if (typeof window.unifiedChatManager[method] === 'function') {
                        addLog(`âœ… æ–¹æ³• ${method} å­˜åœ¨`, 'success');
                    } else {
                        addLog(`âŒ æ–¹æ³• ${method} ä¸å­˜åœ¨`, 'error');
                    }
                });
                
            } catch (error) {
                addLog('âŒ ç»Ÿä¸€èŠå¤©ç®¡ç†å™¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            addLog('ğŸ”§ æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
            
            try {
                const response = await fetch('/api/test/database');
                const data = await response.json();
                
                if (data.success) {
                    addLog('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                    addLog(`ğŸ“Š è¡¨æ•°é‡: ${data.data.table_count}`, 'info');
                    addLog(`ğŸ“Š æµ‹è¯•æŸ¥è¯¢ç»“æœ: ${data.data.test_query}`, 'info');
                } else {
                    addLog('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯API
        async function testMessageAPI() {
            addLog('ğŸ”§ æµ‹è¯•æ¶ˆæ¯API...', 'info');
            
            try {
                const response = await fetch('/api/test/message-service');
                const data = await response.json();
                
                if (data.success) {
                    addLog('âœ… æ¶ˆæ¯æœåŠ¡æµ‹è¯•æˆåŠŸ', 'success');
                    addLog(`ğŸ“Š æ•°æ®åº“è¿æ¥: ${data.data.db_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'info');
                    addLog(`ğŸ“Š æ¨¡å‹åŠ è½½: ${data.data.model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`, 'info');
                    addLog(`ğŸ“Š å†…å­˜æ¶ˆæ¯æ•°: ${data.data.memory_messages}`, 'info');
                } else {
                    addLog('âŒ æ¶ˆæ¯æœåŠ¡æµ‹è¯•å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('âŒ æ¶ˆæ¯APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•å¯¹è¯API
        async function testConversationAPI() {
            addLog('ğŸ”§ æµ‹è¯•å¯¹è¯API...', 'info');
            
            try {
                const response = await fetch('/api/chat/conversations?user_id=1&user_type=user&limit=5');
                const data = await response.json();
                
                if (data.success) {
                    addLog('âœ… å¯¹è¯APIæµ‹è¯•æˆåŠŸ', 'success');
                    addLog(`ğŸ“Š å¯¹è¯æ•°é‡: ${data.data.length}`, 'info');
                } else {
                    addLog('âŒ å¯¹è¯APIæµ‹è¯•å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('âŒ å¯¹è¯APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•Socketè¿æ¥
        async function testSocketConnection() {
            addLog('ğŸ”§ æµ‹è¯•Socketè¿æ¥...', 'info');
            
            try {
                // å…ˆè®¾ç½®æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯ç”¨äºæµ‹è¯•
                if (!localStorage.getItem('user_token')) {
                    addLog('ğŸ“ è®¾ç½®æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯ç”¨äºæµ‹è¯•...', 'info');
                    localStorage.setItem('user_info', JSON.stringify({
                        id: 1,
                        name: 'æµ‹è¯•ç”¨æˆ·',
                        email: 'test@example.com'
                    }));
                    localStorage.setItem('user_token', 'test-token-for-socket-connection');
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                    if (window.unifiedChatManager) {
                        window.unifiedChatManager.loadUserInfo();
                    }
                }
                
                if (window.unifiedChatManager && window.unifiedChatManager.socket) {
                    addLog('âœ… Socketå®ä¾‹å­˜åœ¨', 'success');
                    addLog(`ğŸ”Œ è¿æ¥çŠ¶æ€: ${window.unifiedChatManager.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'info');
                    addLog(`ğŸ”‘ ç”¨æˆ·Token: ${window.unifiedChatManager.userToken ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`, 'info');
                    
                    if (window.unifiedChatManager.isConnected) {
                        addLog('âœ… Socketè¿æ¥æ­£å¸¸', 'success');
                    } else {
                        addLog('âš ï¸ Socketæœªè¿æ¥ï¼Œå°è¯•é‡è¿...', 'warning');
                        window.unifiedChatManager.initSocket();
                        // ç­‰å¾…è¿æ¥å»ºç«‹
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        if (window.unifiedChatManager.isConnected) {
                            addLog('âœ… Socketé‡è¿æˆåŠŸ', 'success');
                        } else {
                            addLog('âš ï¸ Socketé‡è¿å¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºè®¤è¯é—®é¢˜', 'warning');
                            addLog('ğŸ’¡ æç¤ºï¼šåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œç”¨æˆ·éœ€è¦å…ˆç™»å½•æ‰èƒ½å»ºç«‹Socketè¿æ¥', 'info');
                        }
                    }
                } else {
                    addLog('âŒ Socketå®ä¾‹ä¸å­˜åœ¨', 'error');
                }
            } catch (error) {
                addLog('âŒ Socketè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·ç«¯å®Œæ•´æµç¨‹
        async function testUserWorkflow() {
            addLog('ğŸ”§ æµ‹è¯•ç”¨æˆ·ç«¯å®Œæ•´æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
                const mockUserInfo = {
                    id: 1,
                    name: 'æµ‹è¯•ç”¨æˆ·',
                    type: 'user'
                };
                localStorage.setItem('user_info', JSON.stringify(mockUserInfo));
                localStorage.setItem('user_token', 'mock_token');
                
                addLog('âœ… æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æˆåŠŸ', 'success');
                
                // æµ‹è¯•æ¶ˆæ¯åŠ è½½
                if (window.messageLoader) {
                    try {
                        const conversations = await window.messageLoader.getConversations({ limit: 5 });
                        addLog(`âœ… ç”¨æˆ·ç«¯æ¶ˆæ¯åŠ è½½æˆåŠŸï¼Œå…± ${conversations.length} ä¸ªå¯¹è¯`, 'success');
                    } catch (error) {
                        addLog('âš ï¸ ç”¨æˆ·ç«¯æ¶ˆæ¯åŠ è½½å¤±è´¥: ' + error.message, 'warning');
                    }
                }
                
                // æµ‹è¯•èŠå¤©ç®¡ç†å™¨
                if (window.unifiedChatManager) {
                    addLog('âœ… ç”¨æˆ·ç«¯èŠå¤©ç®¡ç†å™¨å¯ç”¨', 'success');
                }
                
            } catch (error) {
                addLog('âŒ ç”¨æˆ·ç«¯æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æŠ¤å·¥ç«¯å®Œæ•´æµç¨‹
        async function testCaregiverWorkflow() {
            addLog('ğŸ”§ æµ‹è¯•æŠ¤å·¥ç«¯å®Œæ•´æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹ŸæŠ¤å·¥ç™»å½•
                const mockCaregiverInfo = {
                    id: 2,
                    name: 'æµ‹è¯•æŠ¤å·¥',
                    type: 'caregiver'
                };
                localStorage.setItem('caregiver_info', JSON.stringify(mockCaregiverInfo));
                localStorage.setItem('caregiver_token', 'mock_token');
                
                addLog('âœ… æ¨¡æ‹ŸæŠ¤å·¥ç™»å½•æˆåŠŸ', 'success');
                
                // æµ‹è¯•æ¶ˆæ¯åŠ è½½
                if (window.messageLoader) {
                    try {
                        const conversations = await window.messageLoader.getConversations({ limit: 5 });
                        addLog(`âœ… æŠ¤å·¥ç«¯æ¶ˆæ¯åŠ è½½æˆåŠŸï¼Œå…± ${conversations.length} ä¸ªå¯¹è¯`, 'success');
                    } catch (error) {
                        addLog('âš ï¸ æŠ¤å·¥ç«¯æ¶ˆæ¯åŠ è½½å¤±è´¥: ' + error.message, 'warning');
                    }
                }
                
                // æµ‹è¯•èŠå¤©ç®¡ç†å™¨
                if (window.unifiedChatManager) {
                    addLog('âœ… æŠ¤å·¥ç«¯èŠå¤©ç®¡ç†å™¨å¯ç”¨', 'success');
                }
                
            } catch (error) {
                addLog('âŒ æŠ¤å·¥ç«¯æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•è·¨å¹³å°æ¶ˆæ¯
        async function testCrossPlatformMessaging() {
            addLog('ğŸ”§ æµ‹è¯•è·¨å¹³å°æ¶ˆæ¯...', 'info');
            
            try {
                // æµ‹è¯•æ¶ˆæ¯å‘é€
                if (window.unifiedChatManager) {
                    const testContact = {
                        id: 1,
                        name: 'æµ‹è¯•è”ç³»äºº',
                        type: 'user',
                        online: true
                    };
                    
                    // æµ‹è¯•æ‰“å¼€èŠå¤©
                    window.unifiedChatManager.openChat(testContact);
                    addLog('âœ… è·¨å¹³å°èŠå¤©çª—å£æ‰“å¼€æˆåŠŸ', 'success');
                    
                    // æµ‹è¯•å‘é€æ¶ˆæ¯
                    try {
                        const messageData = MessageFormatUtils.buildSendMessageData(1, 'è·¨å¹³å°æµ‹è¯•æ¶ˆæ¯', { recipientType: 'user' });
                        addLog('âœ… è·¨å¹³å°æ¶ˆæ¯æ„å»ºæˆåŠŸ', 'success');
                    } catch (error) {
                        addLog('âŒ è·¨å¹³å°æ¶ˆæ¯æ„å»ºå¤±è´¥: ' + error.message, 'error');
                    }
                }
                
            } catch (error) {
                addLog('âŒ è·¨å¹³å°æ¶ˆæ¯æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ€§èƒ½æµ‹è¯•
        async function testPerformance() {
            addLog('ğŸ”§ è¿è¡Œæ€§èƒ½æµ‹è¯•...', 'info');
            
            const startTime = performance.now();
            
            // æµ‹è¯•ç»„ä»¶åˆå§‹åŒ–æ—¶é—´
            const initStart = performance.now();
            if (window.unifiedChatManager) {
                const initEnd = performance.now();
                addLog(`â±ï¸ ç»„ä»¶åˆå§‹åŒ–æ—¶é—´: ${(initEnd - initStart).toFixed(2)} ms`, 'info');
            }
            
            // æµ‹è¯•æ¶ˆæ¯å¤„ç†æ€§èƒ½
            const messageStart = performance.now();
            for (let i = 0; i < 1000; i++) {
                if (window.MessageFormatUtils) {
                    window.MessageFormatUtils.buildSendMessageData(i, `æµ‹è¯•æ¶ˆæ¯${i}`, { recipientType: 'user' });
                }
            }
            const messageEnd = performance.now();
            addLog(`â±ï¸ 1000æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´: ${(messageEnd - messageStart).toFixed(2)} ms`, 'info');
            
            const endTime = performance.now();
            addLog(`â±ï¸ æ€»æµ‹è¯•æ—¶é—´: ${(endTime - startTime).toFixed(2)} ms`, 'info');
            
            // æ›´æ–°æ€§èƒ½ç»“æœæ˜¾ç¤º
            performanceResults.innerHTML = `
                <div class="text-green-600">âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ</div>
                <div>ç»„ä»¶åˆå§‹åŒ–: ${(initEnd - initStart).toFixed(2)} ms</div>
                <div>1000æ¡æ¶ˆæ¯å¤„ç†: ${(messageEnd - messageStart).toFixed(2)} ms</div>
                <div>æ€»æµ‹è¯•æ—¶é—´: ${(endTime - startTime).toFixed(2)} ms</div>
            `;
        }
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
        async function testMemoryUsage() {
            addLog('ğŸ”§ æ£€æŸ¥å†…å­˜ä½¿ç”¨...', 'info');
            
            if (performance.memory) {
                const memory = performance.memory;
                const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const totalMB = (memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                const limitMB = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                
                addLog(`ğŸ“Š å·²ä½¿ç”¨å†…å­˜: ${usedMB} MB`, 'info');
                addLog(`ğŸ“Š æ€»å†…å­˜: ${totalMB} MB`, 'info');
                addLog(`ğŸ“Š å†…å­˜é™åˆ¶: ${limitMB} MB`, 'info');
                
                // æ›´æ–°æ€§èƒ½ç»“æœæ˜¾ç¤º
                performanceResults.innerHTML = `
                    <div class="text-blue-600">â„¹ï¸ å†…å­˜ä½¿ç”¨æƒ…å†µ</div>
                    <div>å·²ä½¿ç”¨: ${usedMB} MB</div>
                    <div>æ€»è®¡: ${totalMB} MB</div>
                    <div>é™åˆ¶: ${limitMB} MB</div>
                `;
            } else {
                addLog('âš ï¸ æ— æ³•è·å–å†…å­˜ä¿¡æ¯', 'warning');
            }
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            addLog('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            
            await testLocalStorage();
            await testMessageFormat();
            await testMessageLoader();
            await testUnifiedChatManager();
            await testDatabaseConnection();
            await testMessageAPI();
            await testConversationAPI();
            await testSocketConnection();
            await testUserWorkflow();
            await testCaregiverWorkflow();
            await testCrossPlatformMessaging();
            
            addLog('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“‹ æ¶ˆæ¯åŠŸèƒ½ç»¼åˆæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus('overall-status', 'info', 'å‡†å¤‡æµ‹è¯•');
            updateStatus('components-status', 'info', 'æ£€æŸ¥ä¸­');
            updateStatus('api-status', 'info', 'æ£€æŸ¥ä¸­');
            updateStatus('socket-status', 'info', 'æ£€æŸ¥ä¸­');
            
            addLog('â³ ç­‰å¾…è„šæœ¬åŠ¨æ€åŠ è½½å®Œæˆ...', 'info');
        });
    </script>
</body>
</html>
