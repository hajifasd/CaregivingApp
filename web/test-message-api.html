<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯APIæµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/message-format-utils.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">æ¶ˆæ¯APIæµ‹è¯•é¡µé¢</h1>
        
        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
            <div id="user-info-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold" id="user-id">-</div>
                    <div class="text-sm text-gray-600">ç”¨æˆ·ID</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="user-name">-</div>
                    <div class="text-sm text-gray-600">ç”¨æˆ·å§“å</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="user-type">-</div>
                    <div class="text-sm text-gray-600">ç”¨æˆ·ç±»å‹</div>
                </div>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æ ¼å¼æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¶ˆæ¯æ ¼å¼æµ‹è¯•</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium mb-3">æµ‹è¯•æ¶ˆæ¯æ•°æ®</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">æ¥æ”¶è€…ID:</label>
                            <input type="text" id="recipient-id" value="1" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">æ¥æ”¶è€…ç±»å‹:</label>
                            <select id="recipient-type" class="w-full p-2 border rounded">
                                <option value="user">ç”¨æˆ·</option>
                                <option value="caregiver">æŠ¤å·¥</option>
                                <option value="admin">ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">æ¶ˆæ¯å†…å®¹:</label>
                            <textarea id="message-content" class="w-full p-2 border rounded" rows="3">è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">æ¶ˆæ¯ç±»å‹:</label>
                            <select id="message-type" class="w-full p-2 border rounded">
                                <option value="text">æ–‡æœ¬</option>
                                <option value="image">å›¾ç‰‡</option>
                                <option value="file">æ–‡ä»¶</option>
                                <option value="system">ç³»ç»Ÿæ¶ˆæ¯</option>
                            </select>
                        </div>
                        <button onclick="testMessageFormat()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            æµ‹è¯•æ¶ˆæ¯æ ¼å¼
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-3">æ ‡å‡†åŒ–ç»“æœ</h3>
                    <div id="format-result" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
                        <div class="text-gray-500">ç‚¹å‡»"æµ‹è¯•æ¶ˆæ¯æ ¼å¼"æŸ¥çœ‹ç»“æœ...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®éªŒè¯æµ‹è¯• -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æ•°æ®éªŒè¯æµ‹è¯•</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium mb-3">æµ‹è¯•ç”¨ä¾‹</h3>
                    <div class="space-y-2">
                        <button onclick="testValidMessage()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            æµ‹è¯•æœ‰æ•ˆæ¶ˆæ¯
                        </button>
                        <button onclick="testInvalidMessage()" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            æµ‹è¯•æ— æ•ˆæ¶ˆæ¯
                        </button>
                        <button onclick="testMissingFields()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                            æµ‹è¯•ç¼ºå¤±å­—æ®µ
                        </button>
                        <button onclick="testWrongTypes()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                            æµ‹è¯•é”™è¯¯ç±»å‹
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-3">éªŒè¯ç»“æœ</h3>
                    <div id="validation-result" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
                        <div class="text-gray-500">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹ç»“æœ...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ—¥å¿—</h2>
            <div id="test-logs" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
                <div class="text-gray-500">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        const testLogs = document.getElementById('test-logs');
        const formatResult = document.getElementById('format-result');
        const validationResult = document.getElementById('validation-result');
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const logDiv = document.createElement('div');
            logDiv.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            testLogs.appendChild(logDiv);
            testLogs.scrollTop = testLogs.scrollHeight;
        }
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            const userInfo = MessageFormatUtils.getCurrentUserInfo();
            document.getElementById('user-id').textContent = userInfo.id || '-';
            document.getElementById('user-name').textContent = userInfo.name || '-';
            document.getElementById('user-type').textContent = userInfo.type || '-';
        }
        
        // æµ‹è¯•æ¶ˆæ¯æ ¼å¼
        function testMessageFormat() {
            addLog('ğŸ”§ æµ‹è¯•æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–...', 'info');
            
            try {
                const recipientId = document.getElementById('recipient-id').value;
                const recipientType = document.getElementById('recipient-type').value;
                const content = document.getElementById('message-content').value;
                const messageType = document.getElementById('message-type').value;
                
                const messageData = MessageFormatUtils.buildSendMessageData(
                    recipientId,
                    content,
                    {
                        recipientType: recipientType,
                        messageType: messageType
                    }
                );
                
                formatResult.innerHTML = `<pre>${JSON.stringify(messageData, null, 2)}</pre>`;
                addLog('âœ… æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–æˆåŠŸ', 'success');
                
                // éªŒè¯æ¶ˆæ¯
                const validation = MessageFormatUtils.validateMessageData(messageData);
                if (validation.isValid) {
                    addLog('âœ… æ¶ˆæ¯æ•°æ®éªŒè¯é€šè¿‡', 'success');
                } else {
                    addLog('âŒ æ¶ˆæ¯æ•°æ®éªŒè¯å¤±è´¥: ' + validation.errors.join(', '), 'error');
                }
                
            } catch (error) {
                addLog('âŒ æ¶ˆæ¯æ ¼å¼æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                formatResult.innerHTML = `<div class="text-red-600">é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•æœ‰æ•ˆæ¶ˆæ¯
        function testValidMessage() {
            addLog('âœ… æµ‹è¯•æœ‰æ•ˆæ¶ˆæ¯...', 'info');
            
            const validMessage = {
                sender_id: 1,
                sender_type: 'user',
                sender_name: 'æµ‹è¯•ç”¨æˆ·',
                recipient_id: 2,
                recipient_type: 'caregiver',
                content: 'è¿™æ˜¯ä¸€æ¡æœ‰æ•ˆæ¶ˆæ¯',
                message_type: 'text'
            };
            
            const validation = MessageFormatUtils.validateMessageData(validMessage);
            validationResult.innerHTML = `
                <div class="mb-2"><strong>æµ‹è¯•æ•°æ®:</strong></div>
                <pre class="mb-2">${JSON.stringify(validMessage, null, 2)}</pre>
                <div class="mb-2"><strong>éªŒè¯ç»“æœ:</strong></div>
                <div class="${validation.isValid ? 'text-green-600' : 'text-red-600'}">
                    ${validation.isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥'}
                </div>
                ${validation.errors.length > 0 ? `<div class="text-red-600">é”™è¯¯: ${validation.errors.join(', ')}</div>` : ''}
            `;
            
            if (validation.isValid) {
                addLog('âœ… æœ‰æ•ˆæ¶ˆæ¯æµ‹è¯•é€šè¿‡', 'success');
            } else {
                addLog('âŒ æœ‰æ•ˆæ¶ˆæ¯æµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•æ— æ•ˆæ¶ˆæ¯
        function testInvalidMessage() {
            addLog('âŒ æµ‹è¯•æ— æ•ˆæ¶ˆæ¯...', 'info');
            
            const invalidMessage = {
                sender_id: null,
                sender_type: 'invalid_type',
                content: '',
                message_type: 'invalid_type'
            };
            
            const validation = MessageFormatUtils.validateMessageData(invalidMessage);
            validationResult.innerHTML = `
                <div class="mb-2"><strong>æµ‹è¯•æ•°æ®:</strong></div>
                <pre class="mb-2">${JSON.stringify(invalidMessage, null, 2)}</pre>
                <div class="mb-2"><strong>éªŒè¯ç»“æœ:</strong></div>
                <div class="${validation.isValid ? 'text-green-600' : 'text-red-600'}">
                    ${validation.isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥'}
                </div>
                ${validation.errors.length > 0 ? `<div class="text-red-600">é”™è¯¯: ${validation.errors.join(', ')}</div>` : ''}
            `;
            
            if (!validation.isValid) {
                addLog('âœ… æ— æ•ˆæ¶ˆæ¯æµ‹è¯•é€šè¿‡ï¼ˆæ­£ç¡®è¯†åˆ«ä¸ºæ— æ•ˆï¼‰', 'success');
            } else {
                addLog('âŒ æ— æ•ˆæ¶ˆæ¯æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥è¯†åˆ«ä¸ºæ— æ•ˆï¼‰', 'error');
            }
        }
        
        // æµ‹è¯•ç¼ºå¤±å­—æ®µ
        function testMissingFields() {
            addLog('âš ï¸ æµ‹è¯•ç¼ºå¤±å­—æ®µ...', 'info');
            
            const missingFieldsMessage = {
                content: 'åªæœ‰å†…å®¹çš„æ¶ˆæ¯'
            };
            
            const validation = MessageFormatUtils.validateMessageData(missingFieldsMessage);
            validationResult.innerHTML = `
                <div class="mb-2"><strong>æµ‹è¯•æ•°æ®:</strong></div>
                <pre class="mb-2">${JSON.stringify(missingFieldsMessage, null, 2)}</pre>
                <div class="mb-2"><strong>éªŒè¯ç»“æœ:</strong></div>
                <div class="${validation.isValid ? 'text-green-600' : 'text-red-600'}">
                    ${validation.isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥'}
                </div>
                ${validation.errors.length > 0 ? `<div class="text-red-600">é”™è¯¯: ${validation.errors.join(', ')}</div>` : ''}
            `;
            
            if (!validation.isValid) {
                addLog('âœ… ç¼ºå¤±å­—æ®µæµ‹è¯•é€šè¿‡ï¼ˆæ­£ç¡®è¯†åˆ«ç¼ºå¤±å­—æ®µï¼‰', 'success');
            } else {
                addLog('âŒ ç¼ºå¤±å­—æ®µæµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥è¯†åˆ«ç¼ºå¤±å­—æ®µï¼‰', 'error');
            }
        }
        
        // æµ‹è¯•é”™è¯¯ç±»å‹
        function testWrongTypes() {
            addLog('ğŸ” æµ‹è¯•é”™è¯¯ç±»å‹...', 'info');
            
            const wrongTypesMessage = {
                sender_id: 'not_a_number',
                sender_type: 'invalid_type',
                recipient_id: true,
                recipient_type: 123,
                content: 'æ¶ˆæ¯å†…å®¹',
                message_type: 'wrong_type'
            };
            
            const validation = MessageFormatUtils.validateMessageData(wrongTypesMessage);
            validationResult.innerHTML = `
                <div class="mb-2"><strong>æµ‹è¯•æ•°æ®:</strong></div>
                <pre class="mb-2">${JSON.stringify(wrongTypesMessage, null, 2)}</pre>
                <div class="mb-2"><strong>éªŒè¯ç»“æœ:</strong></div>
                <div class="${validation.isValid ? 'text-green-600' : 'text-red-600'}">
                    ${validation.isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥'}
                </div>
                ${validation.errors.length > 0 ? `<div class="text-red-600">é”™è¯¯: ${validation.errors.join(', ')}</div>` : ''}
            `;
            
            if (!validation.isValid) {
                addLog('âœ… é”™è¯¯ç±»å‹æµ‹è¯•é€šè¿‡ï¼ˆæ­£ç¡®è¯†åˆ«ç±»å‹é”™è¯¯ï¼‰', 'success');
            } else {
                addLog('âŒ é”™è¯¯ç±»å‹æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥è¯†åˆ«ç±»å‹é”™è¯¯ï¼‰', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“‹ æ¶ˆæ¯APIæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            updateUserInfo();
        });
    </script>
</body>
</html>
