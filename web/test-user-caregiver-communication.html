<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·-æŠ¤å·¥é€šä¿¡åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .bg-primary { background-color: #165DFF; }
        .text-primary { color: #165DFF; }
        .border-primary { border-color: #165DFF; }
        .bg-success { background-color: #10B981; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">ç”¨æˆ·-æŠ¤å·¥é€šä¿¡åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- æµ‹è¯•è¯´æ˜ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-3">æµ‹è¯•è¯´æ˜</h2>
                <p class="text-blue-700 mb-3">è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ç”¨æˆ·ç«¯å’ŒæŠ¤å·¥ç«¯çš„å®æ—¶é€šä¿¡åŠŸèƒ½ï¼š</p>
                <ol class="list-decimal list-inside text-blue-700 space-y-1">
                    <li>æ¨¡æ‹Ÿç”¨æˆ·å’ŒæŠ¤å·¥ç™»å½•çŠ¶æ€</li>
                    <li>æµ‹è¯•WebSocketè¿æ¥</li>
                    <li>éªŒè¯æ¶ˆæ¯å‘é€å’Œæ¥æ”¶</li>
                    <li>æ£€æŸ¥æŠ¤å·¥ç«¯æ˜¯å¦èƒ½å®æ—¶çœ‹åˆ°ç”¨æˆ·æ¶ˆæ¯</li>
                </ol>
            </div>

            <!-- ç”¨æˆ·ç«¯æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-green-600">ç”¨æˆ·ç«¯æµ‹è¯•</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·IDï¼š</label>
                        <input type="text" id="user-id" placeholder="è¾“å…¥ç”¨æˆ·ID" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å§“åï¼š</label>
                        <input type="text" id="user-name" placeholder="è¾“å…¥ç”¨æˆ·å§“å" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="loginUser()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        ç™»å½•ç”¨æˆ·
                    </button>
                    <button onclick="logoutUser()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ç™»å‡ºç”¨æˆ·
                    </button>
                    <button onclick="testUserMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        å‘é€æµ‹è¯•æ¶ˆæ¯
                    </button>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-600">ç”¨æˆ·çŠ¶æ€ï¼š</span>
                    <span id="user-status" class="font-medium text-red-600">æœªç™»å½•</span>
                </div>
            </div>

            <!-- æŠ¤å·¥ç«¯æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-blue-600">æŠ¤å·¥ç«¯æµ‹è¯•</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŠ¤å·¥IDï¼š</label>
                        <input type="text" id="caregiver-id" placeholder="è¾“å…¥æŠ¤å·¥ID" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŠ¤å·¥å§“åï¼š</label>
                        <input type="text" id="caregiver-name" placeholder="è¾“å…¥æŠ¤å·¥å§“å" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="loginCaregiver()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        ç™»å½•æŠ¤å·¥
                    </button>
                    <button onclick="logoutCaregiver()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ç™»å‡ºæŠ¤å·¥
                    </button>
                    <button onclick="loadCaregiverChats()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        åŠ è½½èŠå¤©åˆ—è¡¨
                    </button>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-600">æŠ¤å·¥çŠ¶æ€ï¼š</span>
                    <span id="caregiver-status" class="font-medium text-red-600">æœªç™»å½•</span>
                </div>
            </div>

            <!-- é€šä¿¡æµ‹è¯• -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ç”¨æˆ·ç«¯èŠå¤©çª—å£ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h4 class="text-lg font-semibold mb-4 text-green-600">ç”¨æˆ·ç«¯èŠå¤©çª—å£</h4>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="user-message-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <button onclick="sendUserMessage()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                å‘é€
                            </button>
                        </div>
                        <div id="user-chat-messages" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <p class="text-gray-500 text-center py-8">ç”¨æˆ·ç«¯èŠå¤©è®°å½•</p>
                        </div>
                    </div>
                </div>

                <!-- æŠ¤å·¥ç«¯èŠå¤©çª—å£ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h4 class="text-lg font-semibold mb-4 text-blue-600">æŠ¤å·¥ç«¯èŠå¤©çª—å£</h4>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="caregiver-message-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <button onclick="sendCaregiverMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                å‘é€
                            </button>
                        </div>
                        <div id="caregiver-chat-messages" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <p class="text-gray-500 text-center py-8">æŠ¤å·¥ç«¯èŠå¤©è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ç»“æœ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">æµ‹è¯•ç»“æœ</h3>
                <div id="test-results" class="space-y-2 text-sm max-h-64 overflow-y-auto">
                    <p class="text-gray-500">ç­‰å¾…æµ‹è¯•ç»“æœ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let userSocket = null;
        let caregiverSocket = null;
        let currentUser = null;
        let currentCaregiver = null;
        let currentChatUser = null;

        // ç”¨æˆ·ç™»å½•
        function loginUser() {
            const id = document.getElementById('user-id').value.trim();
            const name = document.getElementById('user-name').value.trim();
            
            if (!id || !name) {
                alert('è¯·è¾“å…¥ç”¨æˆ·IDå’Œå§“å');
                return;
            }
            
            currentUser = { id, name };
            document.getElementById('user-status').textContent = 'å·²ç™»å½•';
            document.getElementById('user-status').className = 'font-medium text-green-600';
            
            // åˆå§‹åŒ–ç”¨æˆ·ç«¯WebSocket
            initUserWebSocket();
            
            addTestResult('âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ', 'success');
        }

        // ç”¨æˆ·ç™»å‡º
        function logoutUser() {
            currentUser = null;
            document.getElementById('user-status').textContent = 'æœªç™»å½•';
            document.getElementById('user-status').className = 'font-medium text-red-600';
            
            if (userSocket) {
                userSocket.disconnect();
                userSocket = null;
            }
            
            addTestResult('âŒ ç”¨æˆ·å·²ç™»å‡º', 'error');
        }

        // æŠ¤å·¥ç™»å½•
        function loginCaregiver() {
            const id = document.getElementById('caregiver-id').value.trim();
            const name = document.getElementById('caregiver-name').value.trim();
            
            if (!id || !name) {
                alert('è¯·è¾“å…¥æŠ¤å·¥IDå’Œå§“å');
                return;
            }
            
            currentCaregiver = { id, name };
            document.getElementById('caregiver-status').textContent = 'å·²ç™»å½•';
            document.getElementById('caregiver-status').className = 'font-medium text-green-600';
            
            // åˆå§‹åŒ–æŠ¤å·¥ç«¯WebSocket
            initCaregiverWebSocket();
            
            addTestResult('âœ… æŠ¤å·¥ç™»å½•æˆåŠŸ', 'success');
        }

        // æŠ¤å·¥ç™»å‡º
        function logoutCaregiver() {
            currentCaregiver = null;
            document.getElementById('caregiver-status').textContent = 'æœªç™»å½•';
            document.getElementById('caregiver-status').className = 'font-medium text-red-600';
            
            if (caregiverSocket) {
                caregiverSocket.disconnect();
                caregiverSocket = null;
            }
            
            addTestResult('âŒ æŠ¤å·¥å·²ç™»å‡º', 'error');
        }

        // åˆå§‹åŒ–ç”¨æˆ·ç«¯WebSocket
        function initUserWebSocket() {
            try {
                userSocket = io('http://localhost:8000');
                
                userSocket.on('connect', () => {
                    addTestResult('âœ… ç”¨æˆ·ç«¯WebSocketè¿æ¥æˆåŠŸ', 'success');
                    
                    // è¿æ¥æˆåŠŸåç«‹å³åŠ å…¥ç”¨æˆ·æˆ¿é—´
                    if (currentUser) {
                        userSocket.emit('join', {
                            user_id: currentUser.id,
                            user_type: 'user'
                        });
                        addTestResult(`ğŸ”— ç”¨æˆ· ${currentUser.id} æ­£åœ¨åŠ å…¥æˆ¿é—´...`, 'info');
                    }
                });
                
                userSocket.on('joined_room', (data) => {
                    addTestResult(`âœ… ç”¨æˆ·å·²åŠ å…¥æˆ¿é—´: ${data.room}`, 'success');
                });
                
                userSocket.on('disconnect', () => {
                    addTestResult('âŒ ç”¨æˆ·ç«¯WebSocketè¿æ¥æ–­å¼€', 'error');
                });
                
                userSocket.on('message_received', (data) => {
                    addTestResult(`ğŸ“¨ ç”¨æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯: ${data.content}`, 'info');
                    addUserMessage(data.content, false);
                });
                
                userSocket.on('message_sent', (data) => {
                    addTestResult(`âœ… ç”¨æˆ·æ¶ˆæ¯å‘é€ç¡®è®¤: ${data.content}`, 'success');
                });
                
                userSocket.on('error', (data) => {
                    addTestResult(`âŒ ç”¨æˆ·ç«¯é”™è¯¯: ${data.message}`, 'error');
                });
                
            } catch (error) {
                addTestResult(`âŒ ç”¨æˆ·ç«¯WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–æŠ¤å·¥ç«¯WebSocket
        function initCaregiverWebSocket() {
            try {
                caregiverSocket = io('http://localhost:8000');
                
                caregiverSocket.on('connect', () => {
                    addTestResult('âœ… æŠ¤å·¥ç«¯WebSocketè¿æ¥æˆåŠŸ', 'success');
                    
                    // è¿æ¥æˆåŠŸåç«‹å³åŠ å…¥æŠ¤å·¥æˆ¿é—´
                    if (currentCaregiver) {
                        caregiverSocket.emit('join', {
                            user_id: currentCaregiver.id,
                            user_type: 'caregiver'
                        });
                        addTestResult(`ğŸ”— æŠ¤å·¥ ${currentCaregiver.id} æ­£åœ¨åŠ å…¥æˆ¿é—´...`, 'info');
                    }
                });
                
                caregiverSocket.on('joined_room', (data) => {
                    addTestResult(`âœ… æŠ¤å·¥å·²åŠ å…¥æˆ¿é—´: ${data.room}`, 'success');
                });
                
                caregiverSocket.on('disconnect', () => {
                    addTestResult('âŒ æŠ¤å·¥ç«¯WebSocketè¿æ¥æ–­å¼€', 'error');
                });
                
                caregiverSocket.on('message_received', (data) => {
                    addTestResult(`ğŸ“¨ æŠ¤å·¥ç«¯æ”¶åˆ°æ¶ˆæ¯: ${data.content}`, 'info');
                    addCaregiverMessage(data.content, false);
                });
                
                caregiverSocket.on('message_sent', (data) => {
                    addTestResult(`âœ… æŠ¤å·¥æ¶ˆæ¯å‘é€ç¡®è®¤: ${data.content}`, 'success');
                });
                
                caregiverSocket.on('error', (data) => {
                    addTestResult(`âŒ æŠ¤å·¥ç«¯é”™è¯¯: ${data.message}`, 'error');
                });
                
            } catch (error) {
                addTestResult(`âŒ æŠ¤å·¥ç«¯WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€ç”¨æˆ·æ¶ˆæ¯
        function sendUserMessage() {
            if (!currentUser || !currentCaregiver) {
                alert('è¯·å…ˆç™»å½•ç”¨æˆ·å’ŒæŠ¤å·¥');
                return;
            }
            
            const input = document.getElementById('user-message-input');
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            // æ·»åŠ åˆ°ç”¨æˆ·ç«¯æ˜¾ç¤º
            addUserMessage(content, true);
            
            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            if (userSocket && userSocket.connected) {
                const messageData = {
                    sender_id: currentUser.id,
                    sender_type: 'user',
                    sender_name: currentUser.name,
                    recipient_id: currentCaregiver.id,
                    recipient_type: 'caregiver',
                    content: content,
                    type: 'text'
                };
                
                userSocket.emit('send_message', messageData);
                addTestResult(`ğŸ“¤ ç”¨æˆ·å‘é€æ¶ˆæ¯: ${content}`, 'success');
            }
            
            input.value = '';
        }

        // å‘é€æŠ¤å·¥æ¶ˆæ¯
        function sendCaregiverMessage() {
            if (!currentUser || !currentCaregiver) {
                alert('è¯·å…ˆç™»å½•ç”¨æˆ·å’ŒæŠ¤å·¥');
                return;
            }
            
            const input = document.getElementById('caregiver-message-input');
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            // æ·»åŠ åˆ°æŠ¤å·¥ç«¯æ˜¾ç¤º
            addCaregiverMessage(content, true);
            
            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            if (caregiverSocket && caregiverSocket.connected) {
                const messageData = {
                    sender_id: currentCaregiver.id,
                    sender_type: 'caregiver',
                    sender_name: currentCaregiver.name,
                    recipient_id: currentUser.id,
                    recipient_type: 'user',
                    content: content,
                    type: 'text'
                };
                
                caregiverSocket.emit('send_message', messageData);
                addTestResult(`ğŸ“¤ æŠ¤å·¥å‘é€æ¶ˆæ¯: ${content}`, 'success');
            }
            
            input.value = '';
        }

        // æ·»åŠ ç”¨æˆ·ç«¯æ¶ˆæ¯
        function addUserMessage(content, isOwn) {
            const container = document.getElementById('user-chat-messages');
            const messageClass = isOwn ? 'ml-auto bg-green-600 text-white' : 'mr-auto bg-gray-200 text-gray-800';
            const time = new Date().toLocaleTimeString('zh-CN');
            
            const messageHtml = `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-2">
                    <div class="max-w-xs ${messageClass} rounded-lg p-2 text-sm">
                        <p>${content}</p>
                        <p class="text-xs ${isOwn ? 'text-green-100' : 'text-gray-500'} mt-1">${time}</p>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', messageHtml);
            container.scrollTop = container.scrollHeight;
        }

        // æ·»åŠ æŠ¤å·¥ç«¯æ¶ˆæ¯
        function addCaregiverMessage(content, isOwn) {
            const container = document.getElementById('caregiver-chat-messages');
            const messageClass = isOwn ? 'ml-auto bg-blue-600 text-white' : 'mr-auto bg-gray-200 text-gray-800';
            const time = new Date().toLocaleTimeString('zh-CN');
            
            const messageHtml = `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-2">
                    <div class="max-w-xs ${messageClass} rounded-lg p-2 text-sm">
                        <p>${content}</p>
                        <p class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'} mt-1">${time}</p>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', messageHtml);
            container.scrollTop = container.scrollHeight;
        }

        // æµ‹è¯•ç”¨æˆ·æ¶ˆæ¯
        function testUserMessage() {
            if (!currentUser || !currentCaregiver) {
                alert('è¯·å…ˆç™»å½•ç”¨æˆ·å’ŒæŠ¤å·¥');
                return;
            }
            
            const testMessage = `æµ‹è¯•æ¶ˆæ¯ - ${new Date().toLocaleTimeString('zh-CN')}`;
            document.getElementById('user-message-input').value = testMessage;
            sendUserMessage();
        }

        // åŠ è½½æŠ¤å·¥èŠå¤©åˆ—è¡¨
        function loadCaregiverChats() {
            if (!currentCaregiver) {
                alert('è¯·å…ˆç™»å½•æŠ¤å·¥');
                return;
            }
            
            addTestResult('ğŸ”„ æ­£åœ¨åŠ è½½æŠ¤å·¥èŠå¤©åˆ—è¡¨...', 'info');
            
            // è¿™é‡Œå¯ä»¥è°ƒç”¨APIåŠ è½½æŠ¤å·¥çš„èŠå¤©åˆ—è¡¨
            // æš‚æ—¶æ¨¡æ‹ŸæˆåŠŸ
            setTimeout(() => {
                addTestResult('âœ… æŠ¤å·¥èŠå¤©åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success');
            }, 1000);
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, type = 'info') {
            const resultsContainer = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            
            const colorClass = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const resultHtml = `
                <p class="${colorClass}">
                    [${timestamp}] ${message}
                </p>
            `;
            
            resultsContainer.insertAdjacentHTML('beforeend', resultHtml);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
            
            // é™åˆ¶æ˜¾ç¤ºç»“æœæ•°é‡
            const results = resultsContainer.querySelectorAll('p');
            if (results.length > 30) {
                results[0].remove();
            }
        }

        // ç»‘å®šå›è½¦é”®å‘é€æ¶ˆæ¯
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'user-message-input') {
                    sendUserMessage();
                } else if (e.target.id === 'caregiver-message-input') {
                    sendCaregiverMessage();
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('ğŸš€ ç”¨æˆ·-æŠ¤å·¥é€šä¿¡åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
        });
    </script>
</body>
</html>
