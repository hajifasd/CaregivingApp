<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>护理助手 - 我的聘用</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 引入用户登出功能 -->
        <!-- 引入认证守卫 -->
    <script src="/js/user-auth-guard.js"></script>
    <script src="/js/user-logout.js"></script>
    <!-- 引入用户信息加载器 -->
    <script src="/js/user-info-loader.js"></script>
    <!-- 引入头像管理器 -->
    <script src="../js/avatar-manager.js"></script>
    
    <!-- 配置Tailwind自定义主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#F5F7FA',
                        'neutral-dark': '#4E5969',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                @apply shadow-sm hover:shadow-md transition-shadow duration-300;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800">
    <!-- 顶部导航栏 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-primary flex items-center justify-center">
                    <i class="fa fa-heartbeat text-white text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-primary">护理助手</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="relative">
                <input type="text" placeholder="搜索护工、服务..." 
                    class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 w-64">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-gray-100 relative">
                <i class="fa fa-bell text-gray-600"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-danger rounded-full"></span>
            </button>
            
            <div class="flex items-center gap-3">
                <img src="https://picsum.photos/id/64/40/40" alt="用户头像" class="w-9 h-9 rounded-full object-cover border-2 border-primary/20">
                <div class="hidden md:block">
                    <p class="text-sm font-medium" id="user-name">用户</p>
                    <p class="text-xs text-gray-500" id="user-role">普通用户</p>
                </div>
                <button id="logout-btn" class="ml-2 text-sm text-gray-500 hover:text-primary">登出</button>
            </div>
        </div>
    </header>
    
    <!-- 主导航菜单 -->
    <nav class="bg-white border-b border-gray-200 px-6">
        <div class="flex items-center space-x-8">
            <a href="/user/home" class="py-4 px-2 text-gray-500 hover:text-primary hover:border-b-2 hover:border-primary/50">
                首页
            </a>
            <a href="/user/profile" class="py-4 px-2 text-gray-500 hover:text-primary hover:border-b-2 hover:border-primary/50">
                个人信息
            </a>
            <a href="/user/caregivers" class="py-4 px-2 text-gray-500 hover:text-primary hover:border-b-2 hover:border-primary/50">
                寻找护工
            </a>
            <a href="/user/appointments" class="py-4 px-2 text-gray-500 hover:text-primary hover:border-b-2 hover:border-primary/50">
                我的预约
            </a>
            <a href="/user/employments" class="py-4 px-2 text-primary border-b-2 border-primary">
                我的聘用
            </a>
            <button id="refresh-employments" class="ml-4 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                <i class="fa fa-refresh mr-2"></i>刷新
            </button>
            <a href="/user/messages" class="py-4 px-2 text-gray-500 hover:text-primary hover:border-b-2 hover:border-primary/50">
                消息中心
            </a>
            <a href="#" class="py-4 px-2 text-danger hover:text-danger/80 hover:border-b-2 hover:border-danger/50">
                紧急呼叫
            </a>
        </div>
    </nav>
    
    <!-- 页面内容 -->
    <main class="p-6 bg-gray-50">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">我的聘用管理</h2>
            <p class="text-gray-600 text-lg">管理您的长期护理服务聘用关系</p>
        </div>
        
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow text-center">
                <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center mx-auto mb-3">
                    <i class="fa fa-handshake-o text-primary text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-primary mb-1">3</h3>
                <p class="text-sm text-gray-600">总聘用数</p>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow text-center">
                <div class="w-12 h-12 rounded-lg bg-success/10 flex items-center justify-center mx-auto mb-3">
                    <i class="fa fa-play-circle text-success text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-success mb-1">1</h3>
                <p class="text-sm text-gray-600">已接受</p>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow text-center">
                <div class="w-12 h-12 rounded-lg bg-warning/10 flex items-center justify-center mx-auto mb-3">
                    <i class="fa fa-clock-o text-warning text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-warning mb-1">1</h3>
                <p class="text-sm text-gray-600">待回复</p>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow text-center">
                <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mx-auto mb-3">
                    <i class="fa fa-check-circle text-gray-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-600 mb-1">1</h3>
                <p class="text-sm text-gray-600">已完成</p>
            </div>
        </div>
        
        <!-- 筛选和操作区域 -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex flex-wrap gap-4">
                    <button class="px-4 py-2 bg-primary text-white rounded-lg text-sm">全部</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">已接受</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">待回复</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">已完成</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">已终止</button>
                </div>
                <button class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fa fa-plus mr-2"></i>新建聘用
                </button>
            </div>
        </div>
        
        <!-- 聘用列表 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="employments-container">
            <!-- 聘用卡片将通过JavaScript动态生成 -->
        </div>
        
        <!-- 分页 -->
        <div class="flex justify-center mt-8">
            <nav class="flex items-center space-x-2">
                <button class="px-3 py-2 text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fa fa-chevron-left"></i>
                </button>
                <button class="px-3 py-2 bg-primary text-white rounded-lg">1</button>
                <button class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">2</button>
                <button class="px-3 py-2 text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fa fa-chevron-right"></i>
                </button>
            </nav>
        </div>
    </main>
    
    <!-- 返回顶部按钮 -->
    <button id="back-to-top" class="fixed bottom-6 right-6 w-12 h-12 bg-primary text-white rounded-full shadow-lg hover:bg-primary/90 transition-all duration-300 hidden">
        <i class="fa fa-arrow-up"></i>
    </button>
    
    <script>
        // 页面数据
        // 聘用数据（从后端API获取）
        let employmentsData = [];
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 首先初始化用户信息加载器
            if (window.userInfoLoader) {
                window.userInfoLoader.init().then(() => {
                    console.log('用户信息加载器初始化完成');
                });
            }
            
            // 检查登录状态
            checkAuth();
            
            // 从后端加载聘用数据
            loadEmploymentsData();
            
            // 绑定返回顶部按钮
            bindBackToTop();
            
            // 绑定筛选按钮事件
            bindFilterEvents();
            
            // 绑定刷新按钮事件
            bindRefreshButton();
        });
        
        // 检查认证状态
        function checkAuth() {
            const token = localStorage.getItem('user_token') || getCookie('user_token');
            if (!token) {
                window.location.href = '/index.html';
                return;
            }

            // 检查token是否有效（基本验证）
            try {
                const payload = token.split('.')[1];
                if (payload) {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/')))));
                    console.log('解析的token载荷:', decoded);
                    
                    if (decoded.user_id && decoded.user_type === 'user') {
                        // token有效，用户信息由用户信息加载器处理
                        console.log('用户认证通过，用户ID:', decoded.user_id);
                        return;
                    }
                }
            } catch (e) {
                console.error('解析token失败:', e);
            }

            // 如果token无效，清除并跳转
            localStorage.removeItem('user_token');
            document.cookie = 'user_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/index.html';
        }

        // 获取cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // 获取当前用户ID（从token中解析）
        function getCurrentUserId() {
            const token = localStorage.getItem('user_token') || getCookie('user_token');
            if (!token) {
                console.error('未找到用户token');
                return null;
            }
            
            try {
                // 解析JWT token
                const payload = token.split('.')[1];
                if (payload) {
                    // 使用更兼容的base64解码方法
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(payload.replace(/-/g, '+').replace(/_/g, '/')))));
                    console.log('解析的token载荷:', decoded);
                    
                    // 检查用户类型
                    if (decoded.user_id && decoded.user_type === 'user') {
                        return decoded.user_id;
                    }
                }
            } catch (e) {
                console.error('解析token失败:', e);
            }
            
            // 如果解析失败，尝试从localStorage中获取用户信息
            try {
                const userInfo = localStorage.getItem('user_info');
                if (userInfo) {
                    const info = JSON.parse(userInfo);
                    return info.id;
                }
            } catch (e) {
                console.error('解析用户信息失败:', e);
            }
            
            console.error('无法获取用户ID');
            return null;
        }

        // 更新用户信息显示
        function updateUserInfo(user) {
            // 使用用户信息加载器来更新显示
            if (window.userInfoLoader) {
                window.userInfoLoader.userInfo = user;
                window.userInfoLoader.updateUserDisplay();
            } else {
                // 备用方案：直接更新元素
                const userNameElement = document.getElementById('user-name');
                const userRoleElement = document.getElementById('user-role');
                
                if (userNameElement) {
                    userNameElement.textContent = user.name || user.fullname || '用户';
                }
                if (userRoleElement) {
                    userRoleElement.textContent = user.role || '普通用户';
                }
            }
        }

        // 从后端加载聘用数据
        async function loadEmploymentsData() {
            try {
                const token = localStorage.getItem('user_token') || getCookie('user_token');
                if (!token) {
                    console.error('未找到用户token');
                    return;
                }

                // 从token中获取用户ID
                const userId = getCurrentUserId();
                if (!userId) {
                    console.error('无法获取用户ID');
                    return;
                }

                const response = await fetch(`/api/employment/applications/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('API响应数据:', data);
                    if (data.success) {
                        employmentsData = data.data || [];
                        console.log('聘用数据:', employmentsData);
                        generateEmploymentsList();
                    } else {
                        console.error('加载聘用数据失败:', data.message);
                        showEmptyState();
                    }
                } else {
                    console.error('API请求失败:', response.status);
                    showEmptyState();
                }
            } catch (error) {
                console.error('加载聘用数据失败:', error);
                showEmptyState();
            }
        }

        // 更新统计卡片
        function updateStatisticsCards() {
            if (!employmentsData || employmentsData.length === 0) {
                return;
            }
            
            // 计算各种状态的聘用数量
            const total = employmentsData.length;
            const pending = employmentsData.filter(e => e.status === 'pending').length;
            const accepted = employmentsData.filter(e => e.status === 'accepted').length;
            const active = employmentsData.filter(e => e.status === 'active').length;
            const completed = employmentsData.filter(e => e.status === 'completed').length;
            const rejected = employmentsData.filter(e => e.status === 'rejected').length;
            const cancelled = employmentsData.filter(e => e.status === 'cancelled').length;
            
            // 更新统计卡片显示
            const totalElement = document.querySelector('h3.text-2xl.font-bold.text-primary');
            const activeElement = document.querySelector('h3.text-2xl.font-bold.text-success');
            const pendingElement = document.querySelector('h3.text-2xl.font-bold.text-warning');
            const completedElement = document.querySelector('h3.text-2xl.font-bold.text-gray-600');
            
            if (totalElement) totalElement.textContent = total;
            // "进行中"卡片显示已接受的申请数量
            if (activeElement) activeElement.textContent = accepted;
            // "待开始"卡片显示待回复的申请数量
            if (pendingElement) pendingElement.textContent = pending;
            if (completedElement) completedElement.textContent = completed;
            
            console.log('统计卡片更新:', {
                total,
                pending,
                accepted,
                active,
                completed,
                rejected,
                cancelled
            });
        }

        // 显示空状态
        function showEmptyState() {
            const container = document.getElementById('employments-container');
            container.innerHTML = `
                <div class="text-center py-16">
                    <i class="fa fa-inbox text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">暂无聘用记录</h3>
                    <p class="text-gray-500 mb-6">您还没有聘用过护工，快去寻找合适的护工吧！</p>
                    <a href="/user/caregivers" class="inline-block bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fa fa-search mr-2"></i>寻找护工
                    </a>
                </div>
            `;
        }

        // 生成聘用列表
        function generateEmploymentsList() {
            const container = document.getElementById('employments-container');
            
            if (!employmentsData || employmentsData.length === 0) {
                showEmptyState();
                return;
            }
            
            // 更新统计卡片
            updateStatisticsCards();
            
            container.innerHTML = employmentsData.map(employment => `
                <div class="bg-white rounded-xl overflow-hidden card-shadow">
                    <div class="relative">
                        <img src="${window.AvatarManager.getAvatarUrl(employment.caregiver_avatar, 'caregiver', 'large')}" alt="${employment.caregiver_name}工作照" class="w-full h-48 object-cover">
                        <div class="absolute top-3 right-3 ${getStatusBadgeClass(employment.status)} text-white text-xs px-2 py-1 rounded-full">
                            ${getStatusText(employment.status)}
                        </div>
                        <div class="absolute top-3 left-3 bg-white/90 text-gray-800 text-xs px-2 py-1 rounded-full">
                            <i class="fa fa-calendar mr-1"></i>${formatDuration(employment.proposed_start_date, employment.proposed_end_date)}
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-lg">${employment.caregiver_name}/* 用户</h4>
                                <p class="text-sm text-gray-500">ID: ${employment.caregiver_id}</p>
                            </div>
                            <div class="flex items-center">
                                <i class="fa fa-star text-warning mr-1"></i>
                                <span class="text-sm font-medium">${employment.caregiver_rating || '4.5'}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fa fa-tag text-primary w-4"></i>
                                <span class="text-sm">${employment.service_type || '护理服务'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa fa-calendar text-primary w-4"></i>
                                <span class="text-sm">${formatDate(employment.proposed_start_date)} 至 ${employment.proposed_end_date ? formatDate(employment.proposed_end_date) : '待定'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa fa-clock-o text-primary w-4"></i>
                                <span class="text-sm">${employment.proposed_hours ? `${employment.proposed_hours}小时` : '待定'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa fa-money text-primary w-4"></i>
                                <span class="text-sm">¥${employment.proposed_rate || '待定'}/小时</span>
                            </div>
                        </div>
                        
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${employment.application_message || '用户申请聘用护工服务'}</p>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-center">
                                <p class="text-xs text-gray-500">申请时间</p>
                                <p class="text-lg font-bold text-primary">${formatDate(employment.created_at)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500">状态</p>
                                <p class="text-lg font-bold text-secondary">${getStatusText(employment.status)}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="flex-1 border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg transition-colors text-sm" onclick="viewEmploymentDetail(${employment.id})">
                                查看详情
                            </button>
                            ${getActionButton(employment.status, employment.id)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 获取状态徽章样式类
        function getStatusBadgeClass(status) {
            const statusMap = {
                'pending': 'bg-warning',
                'accepted': 'bg-success',
                'rejected': 'bg-danger',
                'cancelled': 'bg-gray-500',
                'active': 'bg-success',
                'completed': 'bg-gray-500',
                'terminated': 'bg-danger'
            };
            return statusMap[status] || 'bg-gray-500';
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'pending': '待回复',
                'accepted': '已接受',
                'rejected': '已拒绝',
                'cancelled': '已取消',
                'active': '进行中',
                'completed': '已完成',
                'terminated': '已终止'
            };
            return statusMap[status] || status;
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '待定';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 格式化持续时间
        function formatDuration(startDate, endDate) {
            if (!startDate) return '待定';
            if (!endDate) return '长期';
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 7) return `${diffDays}天`;
            if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}周`;
            if (diffDays <= 365) return `${Math.ceil(diffDays / 30)}个月`;
            return `${Math.ceil(diffDays / 365)}年`;
        }
        
        // 获取操作按钮
        function getActionButton(status, id) {
            switch (status) {
                case 'pending':
                    return `<button class="flex-1 bg-warning hover:bg-warning/90 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="cancelApplication(${id})">取消申请</button>`;
                case 'accepted':
                    return `<button class="flex-1 bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="startEmployment(${id})">开始服务</button>`;
                case 'rejected':
                    return `<button class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm" disabled>已拒绝</button>`;
                case 'cancelled':
                    return `<button class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm" disabled>已取消</button>`;
                case 'active':
                    return `<button class="flex-1 bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="completeEmployment(${id})">完成服务</button>`;
                case 'completed':
                    return `<button class="flex-1 bg-warning hover:bg-warning/90 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="writeReview(${id})">写评价</button>`;
                default:
                    return '';
            }
        }
        
        // 绑定刷新按钮事件
        function bindRefreshButton() {
            const refreshBtn = document.getElementById('refresh-employments');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.disabled = true;
                    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>刷新中...';
                    
                    loadEmploymentsData().finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="fa fa-refresh mr-2"></i>刷新';
                    });
                });
            }
        }

        // 绑定筛选按钮事件
        function bindFilterEvents() {
            const filterButtons = document.querySelectorAll('.bg-gray-100');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除其他按钮的选中状态
                    filterButtons.forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('bg-gray-100', 'text-gray-700');
                    });
                    
                    // 设置当前按钮为选中状态
                    this.classList.remove('bg-gray-100', 'text-gray-700');
                    this.classList.add('bg-primary', 'text-white');
                    
                    // 这里可以添加筛选逻辑
                    const filterType = this.textContent.trim();
                    console.log('筛选类型:', filterType);
                });
            });
        }
        
        // 查看聘用详情
        function viewEmploymentDetail(id) {
            window.location.href = `/user/employments?id=${id}&view=detail`;
        }

        // 取消申请
        function cancelApplication(id) {
            if (confirm('确定要取消这个聘用申请吗？取消后无法恢复。')) {
                const token = localStorage.getItem('user_token') || getCookie('user_token');
                
                // 显示加载状态
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '取消中...';
                
                fetch('/api/employment/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        application_id: id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 成功取消，重新加载数据（这会从界面中删除该申请）
                        loadEmploymentsData();
                        showNotification('申请已取消', 'success');
                    } else {
                        showNotification(data.message || '取消失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('取消申请失败:', error);
                    showNotification('网络错误，请稍后重试', 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    button.disabled = false;
                    button.textContent = originalText;
                });
            }
        }
        
        // 开始聘用服务
        function startEmployment(id) {
            if (confirm('确定要开始这个聘用服务吗？')) {
                // 这里应该调用实际的开始服务API
                alert('聘用服务已开始');
                // 刷新页面数据
                location.reload();
            }
        }
        
        // 完成聘用服务
        function completeEmployment(id) {
            if (confirm('确定要完成这个聘用服务吗？')) {
                // 这里应该调用实际的完成服务API
                alert('聘用服务已完成');
                // 刷新页面数据
                location.reload();
            }
        }
        
        // 写评价
        function writeReview(id) {
            window.location.href = `/user/employments?id=${id}&action=review`;
        }
        
        // 绑定返回顶部按钮
        function bindBackToTop() {
            const backToTopBtn = document.getElementById('back-to-top');
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.remove('hidden');
                } else {
                    backToTopBtn.classList.add('hidden');
                }
            });
            
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // 根据类型设置样式
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        

    </script>
</body>
</html>
