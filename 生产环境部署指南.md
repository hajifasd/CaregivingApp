# 护工资源管理系统 - 生产环境部署指南

## 概述

本文档详细说明如何将护工资源管理系统部署到公网服务器上，使用环境变量管理配置，确保安全性和可维护性。

## 为什么选择环境变量方案？

### 优势
1. **安全性高**：敏感信息不会出现在代码中
2. **环境隔离**：开发、测试、生产环境配置完全分离
3. **标准化**：符合12-Factor App原则
4. **容器友好**：支持Docker、Kubernetes等容器化部署
5. **运维友好**：便于CI/CD流水线管理

### 适用场景
- 云服务器部署
- Docker容器化部署
- Kubernetes集群部署
- 多环境管理

## 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   Web服务器     │    │   数据库服务器   │
│   (Nginx)       │◄──►│   (Flask App)   │◄──►│   (MySQL)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   静态文件       │
                       │   (uploads)     │
                       └─────────────────┘
```

## 服务器环境准备

### 1. 系统要求
- **操作系统**：Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **内存**：最少2GB，推荐4GB+
- **存储**：最少20GB可用空间
- **网络**：公网IP，开放80/443端口

### 2. 安装必要软件

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python 3.8+
sudo apt install python3 python3-pip python3-venv -y

# 安装MySQL
sudo apt install mysql-server -y

# 安装Nginx
sudo apt install nginx -y

# 安装Git
sudo apt install git -y
```

### 3. 配置MySQL

```bash
# 安全配置MySQL
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE caregiving_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用用户
CREATE USER 'caregiving_user'@'localhost' IDENTIFIED BY 'strong_password_here';

-- 授权
GRANT ALL PRIVILEGES ON caregiving_db.* TO 'caregiving_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

## 应用部署

### 1. 克隆项目

```bash
# 创建应用目录
sudo mkdir -p /var/www/caregiving
sudo chown $USER:$USER /var/www/caregiving

# 克隆项目
cd /var/www/caregiving
git clone <your-repository-url> .
```

### 2. 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置环境变量

```bash
# 复制环境变量示例文件
cp env.example .env

# 编辑配置文件
nano .env
```

**生产环境 .env 配置示例：**

```bash
# ==================== 环境配置 ====================
FLASK_ENV=production

# ==================== 数据库配置 ====================
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USERNAME=caregiving_user
MYSQL_PASSWORD=strong_password_here
MYSQL_DATABASE=caregiving_db

# ==================== 应用配置 ====================
# 使用强随机密钥（可以使用 openssl rand -hex 32 生成）
APP_SECRET=your_very_long_random_secret_key_here
FLASK_SECRET_KEY=your_very_long_random_flask_key_here

# ==================== 管理员配置 ====================
ADMIN_USERNAME=admin
ADMIN_PASSWORD=very_strong_admin_password_here

# ==================== 生产环境额外配置 ====================
SERVER_HOST=0.0.0.0
SERVER_PORT=5000
LOG_LEVEL=WARNING
```

### 4. 生成强密钥

```bash
# 生成应用密钥
openssl rand -hex 32

# 生成Flask密钥
openssl rand -hex 32
```

### 5. 初始化数据库

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行数据库迁移（如果有）
cd back
python manage_database.py
```

## 使用Systemd管理服务

### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/caregiving.service
```

**服务配置内容：**

```ini
[Unit]
Description=Caregiving Resource Management System
After=network.target mysql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/caregiving/back
Environment=PATH=/var/www/caregiving/venv/bin
Environment=FLASK_ENV=production
ExecStart=/var/www/caregiving/venv/bin/python app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 2. 启动服务

```bash
# 重新加载systemd
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable caregiving

# 启动服务
sudo systemctl start caregiving

# 检查状态
sudo systemctl status caregiving
```

## Nginx反向代理配置

### 1. 创建Nginx配置

```bash
sudo nano /etc/nginx/sites-available/caregiving
```

**Nginx配置内容：**

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 静态文件
    location /static/ {
        alias /var/www/caregiving/web/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 上传文件
    location /uploads/ {
        alias /var/www/caregiving/web/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端页面
    location / {
        try_files $uri $uri/ /index.html;
        root /var/www/caregiving/web;
        index index.html;
    }
}
```

### 2. 启用站点

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/caregiving /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## SSL证书配置

### 使用Let's Encrypt（免费）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 安全配置

### 1. 防火墙配置

```bash
# 安装UFW
sudo apt install ufw -y

# 配置防火墙
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 2. 定期备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-caregiving.sh
```

**备份脚本内容：**

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/caregiving"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u caregiving_user -p'strong_password_here' caregiving_db > $BACKUP_DIR/db_backup_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_backup_$DATE.tar.gz /var/www/caregiving/web/uploads/

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/backup-caregiving.sh

# 添加到定时任务
sudo crontab -e
# 添加以下行（每天凌晨2点备份）：
# 0 2 * * * /usr/local/bin/backup-caregiving.sh
```

## 监控和日志

### 1. 日志配置

```bash
# 查看应用日志
sudo journalctl -u caregiving -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 2. 性能监控

```bash
# 安装监控工具
sudo apt install htop iotop -y

# 监控系统资源
htop
```

## 更新部署

### 1. 代码更新流程

```bash
# 进入项目目录
cd /var/www/caregiving

# 拉取最新代码
git pull origin main

# 更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 重启服务
sudo systemctl restart caregiving
```

### 2. 环境变量更新

```bash
# 编辑环境变量
nano .env

# 重启服务
sudo systemctl restart caregiving
```

## 故障排除

### 常见问题

**Q: 服务启动失败**
```bash
# 查看详细日志
sudo journalctl -u caregiving -n 50

# 检查端口占用
sudo netstat -tlnp | grep :5000
```

**Q: 数据库连接失败**
```bash
# 测试数据库连接
mysql -u caregiving_user -p caregiving_db

# 检查MySQL服务状态
sudo systemctl status mysql
```

**Q: Nginx配置错误**
```bash
# 测试Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

## 性能优化

### 1. 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_caregiver_status ON caregivers(status);
CREATE INDEX idx_service_category ON services(category);

-- 优化查询
EXPLAIN SELECT * FROM caregivers WHERE status = 'active';
```

### 2. 应用优化

```python
# 在app.py中添加缓存配置
from flask_caching import Cache

cache = Cache(config={
    'CACHE_TYPE': 'simple',
    'CACHE_DEFAULT_TIMEOUT': 300
})
```

## 总结

使用环境变量方案部署到生产环境的优势：

1. **安全性**：敏感信息完全隔离
2. **可维护性**：配置集中管理
3. **可扩展性**：支持容器化和云部署
4. **标准化**：符合行业最佳实践

建议在生产环境中：
- 使用强密码和密钥
- 启用HTTPS
- 配置防火墙
- 设置定期备份
- 监控系统性能
- 定期更新系统和依赖 